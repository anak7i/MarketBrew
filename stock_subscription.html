<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•èµ„å°åŠ©æ‰?- è‚¡ç¥¨è®¢é˜…æ¨é€?/title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ ?*/
        .navbar {
            background: white;
            padding: 16px 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo img {
            width: 40px;
            height: 40px;
            border-radius: 10px;
        }

        .navbar-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a1a;
            letter-spacing: -0.5px;
        }

        .navbar-subtitle {
            font-size: 13px;
            color: #6b7280;
            margin-left: 16px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .navbar-right {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .subscription-box {
            display: flex;
            align-items: center;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 8px 16px;
            gap: 8px;
            transition: all 0.2s ease;
            position: relative;
        }

        .subscription-box:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }

        .subscription-input {
            border: none;
            background: transparent;
            outline: none;
            font-size: 14px;
            color: #374151;
            width: 180px;
            font-weight: 500;
        }

        .subscription-input::placeholder {
            color: #9ca3af;
            font-weight: 400;
        }

        .subscription-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        .subscription-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
            transform: translateY(-1px);
        }

        .navbar-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 60px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            margin-top: 4px;
        }

        .navbar-suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
            transition: background-color 0.2s;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .navbar-suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .navbar-suggestion-item:last-child {
            border-bottom: none;
        }

        .navbar-suggestion-code {
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }

        .navbar-suggestion-name {
            color: #666;
            font-size: 12px;
        }

        .navbar-btn {
            padding: 6px 12px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            background: white;
            color: #666;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
        }

        .navbar-btn:hover {
            background: #f8f9fa;
            border-color: #d1d9e0;
        }

        .navbar-btn.primary {
            background: #4285f4;
            color: white;
            border-color: #4285f4;
        }

        .navbar-btn.primary:hover {
            background: #3367d6;
            border-color: #3367d6;
        }

        /* ç”¨æˆ·èœå•æ ·å¼ */
        .user-menu {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-greeting {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .user-dropdown {
            position: relative;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .user-dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            padding: 8px 0;
            min-width: 150px;
            display: none;
            z-index: 1000;
        }

        .user-dropdown-menu.show {
            display: block;
        }

        .user-dropdown-menu a {
            display: block;
            padding: 10px 16px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .user-dropdown-menu a:hover {
            background: #f5f5f5;
        }

        .user-dropdown-menu a:last-child {
            color: #dc3545;
        }

        .user-dropdown-menu a:last-child:hover {
            background: #fee;
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 20px;
        }

        /* æ¬¢è¿åŒºåŸŸ */
        .welcome-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .welcome-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .welcome-date {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }

        /* è‚¡ç¥¨å¡ç‰‡åŒºåŸŸ */
        .stocks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stock-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stock-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }

        .stock-card.bullish {
            border-left: 4px solid #00c851;
        }

        .stock-card.bearish {
            border-left: 4px solid #ff4444;
        }

        .stock-card.neutral {
            border-left: 4px solid #ffbb33;
        }

        .stock-name {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }

        .stock-price {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .stock-change {
            font-size: 14px;
            font-weight: 500;
        }

        .stock-change.positive {
            color: #00c851;
        }

        .stock-change.negative {
            color: #ff4444;
        }

        .stock-change.neutral {
            color: #ffbb33;
        }

        /* æ™ºèƒ½ç®€æŠ?*/
        .report-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .report-content {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            min-height: 200px;
        }

        .empty-report {
            text-align: center;
            color: #94a3b8;
            font-size: 16px;
            line-height: 1.6;
            padding: 60px 20px;
        }

        .report-loading {
            text-align: center;
            color: #3b82f6;
            font-size: 16px;
            padding: 60px 20px;
        }

        .report-generated {
            font-size: 14px;
            line-height: 1.7;
            color: #374151;
        }

        .report-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }

        .report-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin: 20px 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-item {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #3b82f6;
        }

        .report-stock-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .report-summary {
            color: #4b5563;
            margin-bottom: 8px;
        }

        .report-impact {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 8px 12px;
            color: #0369a1;
            font-size: 13px;
        }

        .report-impact.positive {
            background: #f0fdf4;
            border-color: #bbf7d0;
            color: #166534;
        }

        .report-impact.negative {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }

        .report-impact.neutral {
            background: #fffbeb;
            border-color: #fed7aa;
            color: #d97706;
        }

        /* ä»Šæ—¥æ¨è */
        .recommendation-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .recommendation-card {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid #ff9800;
        }

        .recommendation-time {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .recommendation-content {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 12px;
        }

        .recommendation-detail {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .recommendation-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 4px 8px;
            background: rgba(255, 152, 0, 0.1);
            color: #ff9800;
            border-radius: 4px;
            font-size: 12px;
        }

        .suggestion-box {
            background: #f0f7ff;
            border: 1px solid #e3f2fd;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .suggestion-text {
            font-size: 14px;
            color: #1976d2;
        }

        /* è¶‹åŠ¿å›¾è¡¨åŒºåŸŸ */
        .chart-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .chart-tabs {
            display: flex;
            gap: 16px;
        }

        .chart-tab {
            padding: 6px 12px;
            border: none;
            background: none;
            color: #666;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .chart-tab.active {
            background: #e3f2fd;
            color: #1976d2;
        }

        .chart-placeholder {
            height: 200px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 14px;
        }

        /* è®¢é˜…ç®¡ç†åŒºåŸŸ */
        .subscription-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .subscription-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }


        .subscription-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .subscription-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .subscription-item:hover {
            background: #e9ecef;
            transform: translateX(4px);
        }

        .stock-info {
            flex: 1;
        }

        .stock-code {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .stock-name-sub {
            color: #666;
            font-size: 14px;
        }

        .remove-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .remove-btn:hover {
            background: #cc0000;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #4285f4;
            color: white;
        }

        .btn-primary:hover {
            background: #3367d6;
        }

        .btn-success {
            background: #00c851;
            color: white;
        }

        .btn-success:hover {
            background: #007e33;
        }

        .btn-warning {
            background: #ffbb33;
            color: #333;
        }

        .btn-warning:hover {
            background: #ff8800;
        }

        /* æ¨é€å†å?*/
        .history-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .history-timeline {
            position: relative;
            padding-left: 24px;
        }

        .history-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e1e8ed;
        }

        .history-item {
            position: relative;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .history-item::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4285f4;
            border: 3px solid white;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-stock {
            font-weight: 600;
            color: #333;
        }

        .history-time {
            color: #666;
            font-size: 12px;
        }

        .history-content {
            color: #555;
            font-size: 14px;
            line-height: 1.5;
        }

        /* ç©ºçŠ¶æ€?*/
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* å“åº”å¼è®¾è®?*/
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .stocks-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .navbar {
                padding: 8px 16px;
            }

            .navbar-subtitle {
                display: none;
            }

            .subscription-header {
                flex-direction: column;
                align-items: stretch;
            }

            .subscription-box {
                width: 100%;
            }

            .subscription-input {
                width: calc(100% - 100px);
            }

            .controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* æ–°é—»å…¬å‘Šæ¨¡å—æ ·å¼ */
        .tab-btn.active {
            color: #667eea !important;
            border-bottom-color: #667eea !important;
        }

        .tab-btn:hover {
            color: #4f46e5 !important;
            background-color: #f8fafc !important;
        }

        .news-item, .announcement-item {
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .news-item:hover, .announcement-item:hover {
            background-color: #f8fafc;
            border-radius: 4px;
            margin: 0 -8px;
            padding-left: 8px;
            padding-right: 8px;
        }

        .news-item:last-child, .announcement-item:last-child {
            border-bottom: none;
        }

        .item-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 6px;
        }

        .item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #718096;
        }

        .sentiment, .importance-badge {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ ?-->
    <div class="navbar">
        <div class="navbar-left">
            <div class="logo">
                <img src="marketbrew-logo.png" alt="MarketBrew" />
            </div>
            <div class="navbar-title">MarketBrew</div>
            <div class="navbar-subtitle">One Alpha Latte</div>
        </div>
        <div class="navbar-right">
            <!-- æœªç™»å½•çŠ¶æ€?-->
            <div id="unauthenticatedMenu" style="display: none;">
                <a href="login.html" class="navbar-btn">ç™»å½•</a>
                <a href="login.html" class="navbar-btn primary">æ³¨å†Œ</a>
            </div>
            
            <!-- å·²ç™»å½•çŠ¶æ€?-->
            <div id="authenticatedMenu" style="display: none;">
                <div class="user-menu">
                    <span class="user-greeting">æ¬¢è¿ï¼?span id="userName"></span></span>
                    <div class="user-dropdown">
                        <button class="user-avatar" onclick="toggleUserMenu()">
                            <span id="userInitial"></span>
                        </button>
                        <div class="user-dropdown-menu" id="userDropdownMenu">
                            <a href="#" onclick="showProfile()">ä¸ªäººèµ„æ–™</a>
                            <a href="#" onclick="showSubscriptionHistory()">åˆ†æå†å²</a>
                            <a href="#" onclick="logout()">é€€å‡ºç™»å½?/a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- æ‹©æ—¶åŒºï¼ˆEMTæ•°æ®èšåˆï¼?-->
        <div id="timingZone" style="margin:16px 0; background:white; border:1px solid #e5e7eb; border-radius:12px; padding:16px;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                <div style="font-weight:700; color:#111827; font-size:16px;">ğŸ“Œ æ‹©æ—¶åŒ?/div>
                <div id="timingUpdateTime" style="color:#6b7280; font-size:12px;">åŠ è½½ä¸?..</div><div style="font-size:12px;color:#6b7280;">API: <span id="tzApiStatus">¼ì²éÖĞ...</span></div>
            </div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px;">
                <div class="tz-card" style="border:1px solid #e5e7eb; border-radius:10px; padding:12px;">
                    <div style="font-weight:600; color:#374151; margin-bottom:6px;">è¶‹åŠ¿åˆ¤å®šï¼ˆMA20/30ï¼?/div>
                    <div id="tzTrendMain" style="font-size:14px; color:#111827;">--</div>
                    <div id="tzTrendSub" style="font-size:12px; color:#6b7280; margin-top:6px;">--</div>
                </div>
                <div class="tz-card" style="border:1px solid #e5e7eb; border-radius:10px; padding:12px;">
                    <div style="font-weight:600; color:#374151; margin-bottom:6px;">èµ„é‡‘æµå‘ï¼ˆåŒ—å?ETF/ä¸»åŠ›ï¼?/div>
                    <div id="tzCapitalMain" style="font-size:14px; color:#111827;">--</div>
                    <div id="tzCapitalSub" style="font-size:12px; color:#6b7280; margin-top:6px;">--</div>
                </div>
                <div class="tz-card" style="border:1px solid #e5e7eb; border-radius:10px; padding:12px;">
                    <div style="font-weight:600; color:#374151; margin-bottom:6px;">æƒ…ç»ªå‘¨æœŸ</div>
                    <div id="tzEmotionMain" style="font-size:14px; color:#111827;">--</div>
                    <div id="tzEmotionSub" style="font-size:12px; color:#6b7280; margin-top:6px;">--</div>
                </div>
            </div>
        </div>
        <!-- æ¬¢è¿åŒºåŸŸ -->
        <div class="welcome-section">
            <div class="welcome-title">
                æ¬¢è¿å›æ¥ï¼ğŸ‘?
            </div>
            <div class="welcome-date" id="dynamicDate">
                <!-- åŠ¨æ€æ—¥æœŸå°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            </div>
        </div>

        <!-- æˆ‘çš„å…³æ³¨è‚¡ç¥¨ -->
        <div class="section-title">ğŸŒŸ æˆ‘çš„å…³æ³¨è‚¡ç¥¨</div>
        <div class="stocks-grid" id="stocksGrid">
            <!-- è‚¡ç¥¨å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ?-->
        </div>

        <!-- æ™ºèƒ½ç®€æŠ?-->
        <div class="report-section">
            <div class="report-header">
                <div class="section-title">ğŸ“° æ™ºèƒ½ç®€æŠ?/div>
                <button class="btn btn-primary" onclick="generateWeeklyReport()">
                    ğŸ¤– ä¸€é”®ç”Ÿæˆç®€æŠ?
                </button>
            </div>
            <div class="report-content" id="reportContent">
                <div class="empty-report">
                    ç‚¹å‡»"ä¸€é”®ç”Ÿæˆç®€æŠ?ï¼ŒAIå°†ä¸ºæ‚¨åˆ†ææœ¬å‘¨å¸‚åœºåŠ¨æ€å’Œå…³æ³¨è‚¡ç¥¨çš„æ½œåœ¨å½±å“?
                </div>
            </div>
        </div>

        <!-- ä»Šæ—¥æ¨è -->
        <div class="recommendation-section">
            <div class="section-title">ğŸ’¡ ä»Šæ—¥æ¨è</div>
            <div class="recommendation-card">
                <div class="recommendation-time">
                    ğŸ“… 2024-11-8 15:00 AM &nbsp;&nbsp; ğŸ”¥ è§£è¯»åˆ†æ
                </div>
                <div class="recommendation-content">
                    è…¾è®¯æ§è‚¡ä»ç»´æŒä½ä½ï¼Œå¸‚åœºæƒ…ç»ªè°¨æ… ğŸ’­
                </div>
                <div class="recommendation-detail">
                    è¿‘æœŸå—æ¶ˆæ¯é¢å½±å“ï¼Œè…¾è®¯æ§è‚¡åœ¨æ¸¯è‚¡æŒç»­ä½è¿·ã€‚ä½†ä»åŸºæœ¬é¢åˆ†æï¼Œå…¬å¸æ ¸å¿ƒä¸šåŠ¡ä¾ç„¶ç¨³å¥ï¼Œå…³æ³¨åç»­æ”¿ç­–å˜åŒ–å¯¹è‚¡ä»·çš„å½±å“ã€‚å»ºè®®æŠ•èµ„è€…ä¿æŒå…³æ³¨ï¼Œé€‚å½“åŠ ä»“ä¼˜è´¨ç§‘æŠ€è‚¡ã€?
                </div>
                <div class="recommendation-tags">
                    <span class="tag">ğŸ“± æ ¸å¿ƒæŒä»“</span>
                    <span class="tag">ğŸ¯ é€¢ä½å¸ƒå±€</span>
                </div>
                <div class="suggestion-box">
                    <div class="suggestion-text">
                        ğŸ’¡ å°åŠ©æ‰‹è¯´ï¼šåœ¨ä¿æŒä»“ä½ç¨³å®šçš„åŒæ—¶ï¼Œå»ºè®®å…³æ³¨åå¼¹æ—¶æœºï¼Œåˆç†é…ç½®ä»“ä½ã€?
                    </div>
                </div>
            </div>
        </div>


        <!-- è¶‹åŠ¿å›¾è¡¨ -->
        <div class="chart-section">
            <div class="chart-header">
                <div class="chart-title">è…¾è®¯æ§è‚¡(00700.HK) èµ°åŠ¿</div>
                <div class="chart-tabs">
                    <button class="chart-tab active">æ—¥çº¿</button>
                    <button class="chart-tab">å‘¨çº¿</button>
                    <button class="chart-tab">æœˆçº¿</button>
                </div>
            </div>
            <div class="chart-placeholder">
                ğŸ“ˆ è‚¡ç¥¨èµ°åŠ¿å›¾è¡¨ (æ¼”ç¤ºç‰ˆæœ¬)
            </div>
        </div>

        <!-- è®¢é˜…ç®¡ç† -->
        <div class="subscription-section">
            <div class="subscription-header">
                <div class="section-title">ğŸ“‹ è®¢é˜…ç®¡ç†</div>
                <div class="subscription-box">
                    <input type="text" class="subscription-input" 
                           placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§?.." 
                           id="quickStockInput"
                           onkeypress="handleQuickSearch(event)"
                           oninput="showQuickSuggestions(this.value)">
                    <button class="subscription-btn" onclick="addFromQuick()">
                        æ·»åŠ è®¢é˜…
                    </button>
                    <div class="navbar-suggestions" id="quickSuggestions"></div>
                </div>
            </div>
            
            
            <div class="subscription-list" id="subscriptionList">
                <div class="empty-state">
                    æš‚æ— è®¢é˜…è‚¡ç¥¨ï¼Œè¯·æ·»åŠ æ‚¨å…³æ³¨çš„è‚¡ç¥¨
                </div>
            </div>
        </div>

        <!-- æ–°é—»å…¬å‘Šæ¨¡å— -->
        <div class="news-announcements-section" style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <!-- å¸‚åœºæ¦‚è§ˆç»Ÿè®¡ -->
            <div class="market-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                <div style="text-align: center;">
                    <div style="font-size: 18px; font-weight: 700; color: #667eea;" id="totalNews">--</div>
                    <div style="font-size: 12px; color: #6b7280; font-weight: 500;">ä»Šæ—¥æ–°é—»</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 18px; font-weight: 700; color: #10b981;" id="totalAnnouncements">--</div>
                    <div style="font-size: 12px; color: #6b7280; font-weight: 500;">é‡è¦å…¬å‘Š</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 18px; font-weight: 700; color: #f59e0b;" id="marketSentiment">--</div>
                    <div style="font-size: 12px; color: #6b7280; font-weight: 500;">å¸‚åœºæƒ…ç»ª</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 12px; font-weight: 600; color: #6b7280;" id="lastUpdate">--</div>
                    <div style="font-size: 11px; color: #9ca3af;">æœ€åæ›´æ–?/div>
                </div>
            </div>

            <!-- æ–°é—»å…¬å‘Šæ ‡ç­¾é¡?-->
            <div class="news-tabs" style="display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 16px;">
                <button class="tab-btn active" onclick="switchNewsTab('news')" data-tab="news" 
                        style="flex: 1; padding: 12px 16px; border: none; background: none; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 2px solid transparent; transition: all 0.2s ease; font-size: 14px;">
                    ğŸ“ˆ å¸‚åœºæ–°é—»
                </button>
                <button class="tab-btn" onclick="switchNewsTab('announcements')" data-tab="announcements"
                        style="flex: 1; padding: 12px 16px; border: none; background: none; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 2px solid transparent; transition: all 0.2s ease; font-size: 14px;">
                    ğŸ“„ ä¼ä¸šå…¬å‘Š
                </button>
            </div>

            <!-- æ–°é—»å†…å®¹ -->
            <div class="tab-content" id="newsTabContent" style="max-height: 300px; overflow-y: auto;">
                <div class="empty-state">æ­£åœ¨åŠ è½½æœ€æ–°æ–°é—?..</div>
            </div>

            <!-- å…¬å‘Šå†…å®¹ -->
            <div class="tab-content hidden" id="announcementsTabContent" style="max-height: 300px; overflow-y: auto; display: none;">
                <div class="empty-state">æ­£åœ¨åŠ è½½æœ€æ–°å…¬å‘?..</div>
            </div>

            <!-- åˆ·æ–°æŒ‰é’® -->
            <div style="text-align: center; margin-top: 16px;">
                <button onclick="refreshNewsData()" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease;">
                    ğŸ”„ åˆ·æ–°æ•°æ®
                </button>
            </div>
        </div>

        <!-- å†å²æ¨é€è®°å½?-->
        <div class="history-section">
            <div class="section-title">ğŸ“ å†å²æ¨é€è®°å½?/div>
            <div class="history-timeline" id="pushHistory">
                <div class="empty-state">æ­£åœ¨åŠ è½½æ¨é€å†å?..</div>
            </div>
        </div>
    </div>

    <script>
        // å­˜å‚¨å·¥å…·å‡½æ•°
        function setCookie(name, value, days = 365) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${encodeURIComponent(value)};expires=${expires.toUTCString()};path=/;SameSite=Strict`;
        }
        
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) {
                    return decodeURIComponent(c.substring(nameEQ.length, c.length));
                }
            }
            return null;
        }
        
        function deleteCookie(name) {
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
        }
        
        class StockSubscriptionManager {
            constructor() {
                this.storageKey = 'marketbrew_subscriptions_v2';
                this.subscriptions = this.loadSubscriptions();
                this.pushHistory = this.loadPushHistory();
                this.apiBase = 'http://localhost:5002';
                
                this.initializeUI();
                this.bindEvents();
                this.requestNotificationPermission();
            }

            
            // æµ‹è¯•å­˜å‚¨æ”¯æŒ
            testStorage(type) {
                try {
                    const storage = window[type];
                    const test = '__storage_test__';
                    storage.setItem(test, test);
                    storage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            // æµ‹è¯•Cookieæ”¯æŒ
            testCookie() {
                try {
                    setCookie('__cookie_test__', 'test');
                    const result = getCookie('__cookie_test__') === 'test';
                    deleteCookie('__cookie_test__');
                    return result;
                } catch (e) {
                    return false;
                }
            }
            
            // ä¿å­˜åˆ°å¤šä¸ªå­˜å‚¨ä½ç½?
            saveToStorage(type, data) {
                const key = this.storageKeys[type];
                const jsonData = JSON.stringify(data);
                
                // 1. ä¿å­˜åˆ?localStorage
                if (this.storageSupport.localStorage) {
                    try {
                        localStorage.setItem(key, jsonData);
                        console.log(`âœ?${type} å·²ä¿å­˜åˆ°localStorage`);
                    } catch (e) {
                        console.warn(`âš ï¸ localStorageä¿å­˜${type}å¤±è´¥:`, e);
                    }
                }
                
                // 2. å¤‡ä»½åˆ?sessionStorage  
                if (this.storageSupport.sessionStorage) {
                    try {
                        sessionStorage.setItem(key, jsonData);
                        console.log(`âœ?${type} å·²å¤‡ä»½åˆ°sessionStorage`);
                    } catch (e) {
                        console.warn(`âš ï¸ sessionStorageå¤‡ä»½${type}å¤±è´¥:`, e);
                    }
                }
                
                // 3. å¤‡ä»½åˆ?Cookie (åªä¿å­˜è®¢é˜…æ•°æ®ï¼Œé¿å…cookieå¤ªå¤§)
                if (this.storageSupport.cookie && type === 'subscriptions') {
                    try {
                        const compressed = this.compressData(data);
                        if (compressed.length < 3000) { // Cookieå¤§å°é™åˆ¶
                            setCookie(key, compressed, 365);
                            console.log(`âœ?${type} å·²å¤‡ä»½åˆ°Cookie`);
                        }
                    } catch (e) {
                        console.warn(`âš ï¸ Cookieå¤‡ä»½${type}å¤±è´¥:`, e);
                    }
                }
            }
            
            // ä»å­˜å‚¨åŠ è½½æ•°æ?
            loadFromStorage(type) {
                const key = this.storageKeys[type];
                
                // ä¼˜å…ˆä»localStorageåŠ è½½
                if (this.storageSupport.localStorage) {
                    try {
                        const data = localStorage.getItem(key);
                        if (data) {
                            return JSON.parse(data);
                        }
                    } catch (e) {
                        console.warn(`âš ï¸ localStorageè¯»å–${type}å¤±è´¥:`, e);
                    }
                }
                
                // å…¶æ¬¡ä»sessionStorageåŠ è½½
                if (this.storageSupport.sessionStorage) {
                    try {
                        const data = sessionStorage.getItem(key);
                        if (data) {
                            const parsed = JSON.parse(data);
                            // æ¢å¤åˆ°localStorage
                            this.saveToStorage(type, parsed);
                            return parsed;
                        }
                    } catch (e) {
                        console.warn(`âš ï¸ sessionStorageè¯»å–${type}å¤±è´¥:`, e);
                    }
                }
                
                // æœ€åä»CookieåŠ è½½
                if (this.storageSupport.cookie && type === 'subscriptions') {
                    try {
                        const compressed = getCookie(key);
                        if (compressed) {
                            const data = this.decompressData(compressed);
                            // æ¢å¤åˆ°ä¸»å­˜å‚¨
                            this.saveToStorage(type, data);
                            return data;
                        }
                    } catch (e) {
                        console.warn(`âš ï¸ Cookieè¯»å–${type}å¤±è´¥:`, e);
                    }
                }
                
                return null;
            }
            
            // ç®€å•æ•°æ®å‹ç¼?(å¯¹äºCookieå­˜å‚¨)
            compressData(data) {
                return JSON.stringify(data.map(item => `${item.symbol}|${item.name}`).join(';'));
            }
            
            // æ•°æ®è§£å‹
            decompressData(compressed) {
                try {
                    const str = JSON.parse(compressed);
                    return str.split(';').map(item => {
                        const [symbol, name] = item.split('|');
                        return {
                            symbol,
                            name,
                            addedAt: new Date().toISOString()
                        };
                    });
                } catch (e) {
                    return [];
                }
            }
            
            // å®šæœŸå¤‡ä»½æ•°æ®
            startPeriodicBackup() {
                // æ¯?åˆ†é’Ÿå¤‡ä»½ä¸€æ¬?
                setInterval(() => {
                    if (this.subscriptions.length > 0) {
                        this.saveToStorage('subscriptions', this.subscriptions);
                    }
                    if (this.pushHistory.length > 0) {
                        this.saveToStorage('history', this.pushHistory);
                    }
                }, 5 * 60 * 1000);
            }
            
            loadSubscriptions() {
                try {
                    const saved = localStorage.getItem('stockSubscriptions');
                    if (saved) {
                        const data = JSON.parse(saved);
                        console.log(`âœ?åŠ è½½äº?${data.length} ä¸ªè®¢é˜…`);
                        return data;
                    }
                } catch (e) {
                    console.error('âš ï¸ åŠ è½½è®¢é˜…æ•°æ®å¤±è´¥:', e);
                }
                
                const isLoggedIn = localStorage.getItem('marketbrew_token');
                
                // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œæ°¸è¿œä¸åŠ è½½é»˜è®¤è‚¡ç¥¨ï¼Œè®©ç”¨æˆ·è‡ªå·±é€‰æ‹©
                if (isLoggedIn) {
                    console.log('ğŸ†• ç™»å½•ç”¨æˆ·ï¼Œä»ç©ºè®¢é˜…å¼€å§?);
                    return [];
                }
                
                // ä»…å¯¹æœªç™»å½•çš„æ¸¸å®¢æä¾›ç¤ºä¾‹è‚¡ç¥¨
                const isFirstVisit = !localStorage.getItem('marketbrew_visited');
                if (!isFirstVisit) {
                    localStorage.setItem('marketbrew_visited', 'true');
                    return [
                        {symbol: '000001', name: 'å¹³å®‰é“¶è¡Œ', addedAt: new Date().toISOString()},
                        {symbol: '600519', name: 'è´µå·èŒ…å°', addedAt: new Date().toISOString()},
                        {symbol: '000858', name: 'äº”ç²®æ¶?, addedAt: new Date().toISOString()},
                        {symbol: '300750', name: 'å®å¾·æ—¶ä»£', addedAt: new Date().toISOString()},
                        {symbol: '600362', name: 'æ±Ÿè¥¿é“œä¸š', addedAt: new Date().toISOString()},
                        {symbol: '601899', name: 'ç´«é‡‘çŸ¿ä¸š', addedAt: new Date().toISOString()}
                    ];
                }
                
                // é»˜è®¤è¿”å›ç©ºæ•°ç»?
                return [];
            }

            saveSubscriptions() {
                try {
                    localStorage.setItem('stockSubscriptions', JSON.stringify(this.subscriptions));
                    console.log(`âœ?å·²ä¿å­?${this.subscriptions.length} ä¸ªè®¢é˜…`);
                } catch (e) {
                    console.error('âš ï¸ ä¿å­˜è®¢é˜…æ•°æ®å¤±è´¥:', e);
                }
            }

            loadPushHistory() {
                try {
                    const saved = localStorage.getItem('marketbrew_history_v2');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) {
                    console.error('âš ï¸ åŠ è½½å†å²æ•°æ®å¤±è´¥:', e);
                    return [];
                }
            }

            savePushHistory() {
                try {
                    localStorage.setItem('marketbrew_history_v2', JSON.stringify(this.pushHistory));
                } catch (e) {
                    console.error('âš ï¸ ä¿å­˜å†å²æ•°æ®å¤±è´¥:', e);
                }
            }

            requestNotificationPermission() {
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            }

            async initializeUI() {
                await this.updateStocksGrid();
                this.updateSubscriptionList();
                this.updatePushHistory();
            }

            bindEvents() {
                // ç§»é™¤äº†åŸæ¥çš„æœç´¢åŠŸèƒ½
            }

            async updateStocksGrid() {
                const container = document.getElementById('stocksGrid');
                
                if (this.subscriptions.length === 0) {
                    container.innerHTML = '<div class="empty-state">æš‚æ— å…³æ³¨è‚¡ç¥¨</div>';
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€?
                container.innerHTML = '<div class="empty-state">æ­£åœ¨è·å–å®æ—¶ä»·æ ¼...</div>';
                
                try {
                    // è·å–çœŸå®ä»·æ ¼æ•°æ®
                    const symbols = this.subscriptions.slice(0, 8).map(sub => sub.symbol);
                    const response = await fetch('http://localhost:5002/api/stocks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbols })
                    });
                    
                    let stocksData = [];
                    if (response.ok) {
                        const priceData = await response.json();
                        stocksData = this.subscriptions.slice(0, 8).map(sub => {
                            const priceInfo = priceData[sub.symbol];
                            if (priceInfo && !priceInfo.error) {
                                return {
                                    symbol: sub.symbol,
                                    name: priceInfo.name || sub.name,
                                    price: priceInfo.current_price || 0,
                                    change: priceInfo.change_percent || 0,
                                    type: priceInfo.change_percent > 0 ? 'bullish' : 
                                          priceInfo.change_percent < 0 ? 'bearish' : 'neutral',
                                    volume: priceInfo.volume || 0,
                                    market_status: priceInfo.market_status || 'unknown'
                                };
                            } else {
                                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                                return {
                                    symbol: sub.symbol,
                                    name: sub.name,
                                    price: (Math.random() * 100 + 10).toFixed(2),
                                    change: (Math.random() * 10 - 5).toFixed(2),
                                    type: 'neutral',
                                    volume: Math.floor(Math.random() * 1000000),
                                    market_status: 'unknown'
                                };
                            }
                        });
                    } else {
                        // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                        stocksData = this.subscriptions.slice(0, 8).map(sub => ({
                            symbol: sub.symbol,
                            name: sub.name,
                            price: (Math.random() * 100 + 10).toFixed(2),
                            change: (Math.random() * 10 - 5).toFixed(2),
                            type: 'neutral',
                            volume: Math.floor(Math.random() * 1000000),
                            market_status: 'unknown'
                        }));
                    }
                    
                    container.innerHTML = stocksData.map(stock => {
                        const changeClass = stock.change > 0 ? 'positive' : stock.change < 0 ? 'negative' : 'neutral';
                        const changeIcon = stock.change > 0 ? 'â†? : stock.change < 0 ? 'â†? : 'â†?;
                        const statusIcon = stock.market_status === 'trading' ? 'ğŸŸ¢' : 
                                         stock.market_status === 'closed' ? 'ğŸ”´' : 'ğŸŸ¡';
                        
                        return `
                            <div class="stock-card ${stock.type}">
                                <div class="stock-name">${stock.name} ${statusIcon}</div>
                                <div class="stock-price">Â¥${parseFloat(stock.price).toFixed(2)}</div>
                                <div class="stock-change ${changeClass}">
                                    ${changeIcon} ${stock.change > 0 ? '+' : ''}${parseFloat(stock.change).toFixed(2)}%
                                </div>
                                <div style="font-size: 12px; color: #999; margin-top: 4px;">
                                    æˆäº¤é‡? ${parseInt(stock.volume).toLocaleString()}æ‰?
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                } catch (error) {
                    console.error('è·å–è‚¡ç¥¨ä»·æ ¼å¤±è´¥:', error);
                    // å›é€€åˆ°æ¨¡æ‹Ÿæ•°æ?
                    const mockData = this.subscriptions.slice(0, 8).map(sub => ({
                        symbol: sub.symbol,
                        name: sub.name,
                        price: (Math.random() * 100 + 10).toFixed(2),
                        change: (Math.random() * 10 - 5).toFixed(2),
                        type: 'neutral'
                    }));
                    
                    container.innerHTML = mockData.map(stock => {
                        const changeClass = stock.change > 0 ? 'positive' : stock.change < 0 ? 'negative' : 'neutral';
                        const changeIcon = stock.change > 0 ? 'â†? : stock.change < 0 ? 'â†? : 'â†?;
                        
                        return `
                            <div class="stock-card ${stock.type}">
                                <div class="stock-name">${stock.name} ğŸŸ¡</div>
                                <div class="stock-price">Â¥${parseFloat(stock.price).toFixed(2)}</div>
                                <div class="stock-change ${changeClass}">
                                    ${changeIcon} ${stock.change > 0 ? '+' : ''}${parseFloat(stock.change).toFixed(2)}%
                                </div>
                                <div style="font-size: 12px; color: #999; margin-top: 4px;">
                                    æ¨¡æ‹Ÿæ•°æ®
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }


            async addSubscription(symbol, name) {
                if (this.subscriptions.find(sub => sub.symbol === symbol)) {
                    alert('è¯¥è‚¡ç¥¨å·²åœ¨è®¢é˜…åˆ—è¡¨ä¸­');
                    return;
                }

                this.subscriptions.push({
                    symbol,
                    name,
                    addedAt: new Date().toISOString()
                });

                this.saveSubscriptions();
                this.updateSubscriptionList();
                await this.updateStocksGrid();

                const stockSearch = document.getElementById('stockSearch');
                const searchResults = document.getElementById('searchResults');
                if (stockSearch) stockSearch.value = '';
                if (searchResults) searchResults.style.display = 'none';
                
                // åˆ·æ–°å…¬å‘Šæ•°æ®
                if (typeof loadAnnouncements === 'function') {
                    loadAnnouncements();
                }

                this.showNotification('âœ?è®¢é˜…æˆåŠŸ', `å·²æ·»åŠ?${symbol} ${name} åˆ°è®¢é˜…åˆ—è¡¨`);
            }

            async removeSubscription(symbol) {
                this.subscriptions = this.subscriptions.filter(sub => sub.symbol !== symbol);
                this.saveSubscriptions();
                this.updateSubscriptionList();
                await this.updateStocksGrid();
                
                // åˆ·æ–°å…¬å‘Šæ•°æ®
                if (typeof loadAnnouncements === 'function') {
                    loadAnnouncements();
                }
                
                this.showNotification('ğŸ—‘ï¸?å–æ¶ˆè®¢é˜…', `å·²ç§»é™¤è®¢é˜…è‚¡ç¥¨`);
            }

            updateSubscriptionList() {
                const container = document.getElementById('subscriptionList');

                if (this.subscriptions.length === 0) {
                    // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼Œå†³å®šæ˜¾ç¤ºå†…å®¹
                    const isLoggedIn = window.userManager && window.userManager.isLoggedIn();
                    const emptyMessage = isLoggedIn ? 
                        'æš‚æ— è®¢é˜…è‚¡ç¥¨ï¼Œè¯·æ·»åŠ æ‚¨æ„Ÿå…´è¶£çš„è‚¡ç¥¨è¿›è¡Œåˆ†æ? : 
                        'æš‚æ— è®¢é˜…è‚¡ç¥¨ï¼Œè¯·æ·»åŠ æ‚¨å…³æ³¨çš„è‚¡ç¥¨';
                    
                    container.innerHTML = `
                        <div class="empty-state">
                            ${emptyMessage}<br><br>
                            <button class="btn btn-primary" onclick="restoreSubscriptions()" style="font-size: 12px; padding: 6px 12px;">
                                ğŸ“‹ æ·»åŠ ç¤ºä¾‹è‚¡ç¥¨
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.subscriptions.map(sub => `
                    <div class="subscription-item">
                        <div class="stock-info">
                            <div class="stock-code">${sub.symbol}</div>
                            <div class="stock-name-sub">${sub.name}</div>
                        </div>
                        <button class="remove-btn" onclick="subscriptionManager.removeSubscription('${sub.symbol}')">
                            ç§»é™¤
                        </button>
                    </div>
                `).join('');
            }

            updatePushHistory() {
                const container = document.getElementById('pushHistory');
                
                if (this.pushHistory.length === 0) {
                    // æ˜¾ç¤ºä¸€äº›ç¤ºä¾‹å†å²è®°å½?
                    const sampleHistory = [
                        {
                            symbol: '00700.HK',
                            name: 'è…¾è®¯æ§è‚¡',
                            timestamp: '2024-01-15 14:36',
                            content: 'è¿‘æœŸç›‘ç®¡ç¯å¢ƒæ”¹å–„ï¼Œæ¸¸æˆä¸šåŠ¡å‘åŠ›ï¼Œå»ºè®®å…³æ³¨å›è°ƒä¹°å…¥æœºä¼šã€?
                        },
                        {
                            symbol: '600519',
                            name: 'è´µå·èŒ…å°',
                            timestamp: '2024-01-15 10:21',
                            content: 'æ˜¥èŠ‚æ—ºå­£æ¥ä¸´ï¼Œç™½é…’è¡Œä¸šæ™¯æ°”åº¦æå‡ï¼Œå»ºè®®é€‚åº¦æŒæœ‰ã€?
                        },
                        {
                            symbol: '300750',
                            name: 'å®å¾·æ—¶ä»£',
                            timestamp: '2024-01-14 19:47',
                            content: 'æ–°èƒ½æºæ”¿ç­–æ”¯æŒåŠ›åº¦åŠ å¤§ï¼Œå…³æ³¨ä¸šç»©é‡Šæ”¾æƒ…å†µã€?
                        },
                        {
                            symbol: '002594',
                            name: 'æ¯”äºšè¿?,
                            timestamp: '2024-01-14 11:33',
                            content: 'é”€é‡æ•°æ®è¶…é¢„æœŸï¼Œæ–°è½¦å‹æ¨å‡ºèŠ‚å¥åŠ å¿«ï¼Œç»´æŒä¹°å…¥è¯„çº§ã€?
                        }
                    ];

                    container.innerHTML = sampleHistory.map(item => `
                        <div class="history-item">
                            <div class="history-header">
                                <div class="history-stock">${item.symbol} ${item.name}</div>
                                <div class="history-time">${item.timestamp}</div>
                            </div>
                            <div class="history-content">
                                ${item.content}
                            </div>
                        </div>
                    `).join('');
                    return;
                }

                container.innerHTML = this.pushHistory.slice(-10).reverse().map(item => `
                    <div class="history-item">
                        <div class="history-header">
                            <div class="history-stock">${item.symbol} ${item.name}</div>
                            <div class="history-time">${new Date(item.timestamp).toLocaleString()}</div>
                        </div>
                        <div class="history-content">
                            <strong>æ“ä½œå»ºè®®ï¼?/strong>${item.decision}<br>
                            <strong>å½“å‰ä»·æ ¼ï¼?/strong>Â¥${item.price}<br>
                            <strong>åˆ†æç†ç”±ï¼?/strong>${item.reason}
                        </div>
                    </div>
                `).join('');
            }

            showNotification(title, message) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(title, {
                        body: message,
                        icon: '/favicon.ico'
                    });
                }
            }

        }

        let subscriptionManager;
        let userManager;

        // ç”¨æˆ·ç®¡ç†ç±?
        class UserManager {
            constructor() {
                this.user = null;
                this.token = null;
                this.init();
            }

            init() {
                this.loadUserData();
                this.updateUI();
                
                // å¦‚æœç”¨æˆ·åˆšç™»å½•ï¼Œç¡®ä¿è®¢é˜…çŠ¶æ€æ­£ç¡?
                if (this.isLoggedIn()) {
                    const lastUser = localStorage.getItem('marketbrew_last_user');
                    if (lastUser !== this.user.username) {
                        // ç”¨æˆ·åˆ‡æ¢ï¼Œæ¸…é™¤ä¹‹å‰ç”¨æˆ·çš„æ•°æ®
                        localStorage.setItem('marketbrew_last_user', this.user.username);
                        localStorage.removeItem('marketbrew_visited');
                        localStorage.removeItem('stockSubscriptions');
                        
                        console.log('ğŸ”„ æ£€æµ‹åˆ°ç”¨æˆ·åˆ‡æ¢ï¼Œæ¸…é™¤æ—§è®¢é˜…æ•°æ®');
                    }
                    
                    // å¯¹äºæ‰€æœ‰ç™»å½•ç”¨æˆ·ï¼Œç¡®ä¿ä¸åŠ è½½é»˜è®¤è‚¡ç¥?
                    // ä½¿ç”¨ setTimeout ç¡®ä¿åœ?subscriptionManager åˆå§‹åŒ–ä¹‹åæ‰§è¡?
                    setTimeout(() => {
                        if (window.subscriptionManager) {
                            // å¦‚æœå½“å‰æ²¡æœ‰ä¿å­˜çš„è®¢é˜…æ•°æ®ï¼Œç¡®ä¿ä»ç©ºå¼€å§?
                            const saved = localStorage.getItem('stockSubscriptions');
                            if (!saved) {
                                window.subscriptionManager.subscriptions = [];
                                window.subscriptionManager.updateSubscriptionList();
                                console.log('âœ?ç™»å½•ç”¨æˆ·åˆå§‹åŒ–ä¸ºç©ºè®¢é˜…åˆ—è¡?);
                            }
                        }
                    }, 100);
                }
            }

            loadUserData() {
                this.token = localStorage.getItem('marketbrew_token');
                const userData = localStorage.getItem('marketbrew_user');
                
                if (userData) {
                    try {
                        this.user = JSON.parse(userData);
                    } catch (e) {
                        console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', e);
                        this.clearUserData();
                    }
                }
            }

            updateUI() {
                const authenticatedMenu = document.getElementById('authenticatedMenu');
                const unauthenticatedMenu = document.getElementById('unauthenticatedMenu');
                
                if (this.isLoggedIn()) {
                    authenticatedMenu.style.display = 'block';
                    unauthenticatedMenu.style.display = 'none';
                    
                    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                    const userName = document.getElementById('userName');
                    const userInitial = document.getElementById('userInitial');
                    
                    if (userName) userName.textContent = this.user.username;
                    if (userInitial) {
                        userInitial.textContent = this.user.username.charAt(0).toUpperCase();
                    }
                } else {
                    authenticatedMenu.style.display = 'none';
                    unauthenticatedMenu.style.display = 'flex';
                }
            }

            isLoggedIn() {
                return this.token && this.user;
            }

            clearUserData() {
                this.user = null;
                this.token = null;
                localStorage.removeItem('marketbrew_token');
                localStorage.removeItem('marketbrew_user');
                this.updateUI();
            }

            async logout() {
                this.clearUserData();
                if (subscriptionManager) {
                    subscriptionManager.showNotification('âœ?å·²é€€å‡?, 'æ‚¨å·²æˆåŠŸé€€å‡ºç™»å½?);
                }
                // å¯é€‰æ‹©æ˜¯å¦è·³è½¬åˆ°ç™»å½•é¡µé?
                // window.location.href = 'login.html';
            }

            getAuthHeaders() {
                return this.token ? {
                    'Authorization': `Bearer ${this.token}`,
                    'Content-Type': 'application/json'
                } : { 'Content-Type': 'application/json' };
            }
        }

        // ç”¨æˆ·èœå•ç›¸å…³å‡½æ•°
        function toggleUserMenu() {
            const menu = document.getElementById('userDropdownMenu');
            menu.classList.toggle('show');
        }

        function showProfile() {
            const menu = document.getElementById('userDropdownMenu');
            menu.classList.remove('show');
            
            if (subscriptionManager) {
                subscriptionManager.showNotification('â„¹ï¸ å¼€å‘ä¸­', 'ä¸ªäººèµ„æ–™åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­');
            }
        }

        function showSubscriptionHistory() {
            const menu = document.getElementById('userDropdownMenu');
            menu.classList.remove('show');
            
            if (subscriptionManager) {
                subscriptionManager.showNotification('â„¹ï¸ å¼€å‘ä¸­', 'åˆ†æå†å²åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­');
            }
        }

        function logout() {
            const menu = document.getElementById('userDropdownMenu');
            menu.classList.remove('show');
            
            if (userManager) {
                userManager.logout();
            }
        }

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶å…³é—­ç”¨æˆ·èœå?
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-dropdown')) {
                const menu = document.getElementById('userDropdownMenu');
                if (menu) {
                    menu.classList.remove('show');
                }
            }
        });

        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ MarketBrew æ­£åœ¨åˆå§‹åŒ?..');
            
            // å…ˆåˆå§‹åŒ–ç”¨æˆ·ç®¡ç†ï¼Œç¡®ä¿ç”¨æˆ·çŠ¶æ€æ£€æŸ¥åœ¨å‰?
            userManager = new UserManager();
            window.userManager = userManager;
            
            // ç¨ç­‰ä¸€ä¸‹å†åˆå§‹åŒ–è®¢é˜…ç®¡ç†ï¼Œç¡®ä¿ç”¨æˆ·çŠ¶æ€æ¸…ç†å·²å®Œæˆ
            setTimeout(() => {
                subscriptionManager = new StockSubscriptionManager();
                window.subscriptionManager = subscriptionManager;
                
                // å¦‚æœæ˜¯æ–°ç”¨æˆ·ä¸”æ²¡æœ‰è®¢é˜…ï¼Œç¡®ä¿æ˜¾ç¤ºç©ºçŠ¶æ€?
                if (userManager.isLoggedIn() && subscriptionManager.subscriptions.length === 0) {
                    subscriptionManager.updateSubscriptionList();
                }
            }, 100);
            
            // åˆå§‹åŒ–æ–°é—»å…¬å‘Šæ¨¡å?
            loadMarketStats();
            loadMarketNews();
            loadAnnouncements();
            
            console.log('âœ?MarketBrew åˆå§‹åŒ–å®Œæˆ?);
        });

        // åŠ è½½æ–°é—»é¢„è§ˆåŠŸèƒ½
        // æ–°é—»å…¬å‘Šæ¨¡å—ç›¸å…³å‡½æ•°
        let currentNewsTab = 'news';
        
        async function loadMarketStats() {
            try {
                const newsApiBase = 'http://localhost:5007';
                const [marketNewsResponse, sampleAnnouncementsResponse] = await Promise.all([
                    fetch(`${newsApiBase}/api/market-news?days=1&limit=20`),
                    fetch(`${newsApiBase}/api/announcements/000001?days=1&limit=10`)
                ]);

                const marketNews = await marketNewsResponse.json();
                const sampleAnnouncements = await sampleAnnouncementsResponse.json();

                // è®¡ç®—ç»Ÿè®¡æ•°æ®
                const totalNews = marketNews.success ? marketNews.news_count || 0 : 0;
                const totalAnnouncements = sampleAnnouncements.success ? sampleAnnouncements.announcement_count || 0 : 0;
                
                // è®¡ç®—å¸‚åœºæƒ…ç»ª
                let marketSentiment = 'ä¸­æ€?;
                if (marketNews.success && marketNews.market_news) {
                    const positive = marketNews.market_news.filter(n => n.sentiment === 'positive').length;
                    const negative = marketNews.market_news.filter(n => n.sentiment === 'negative').length;
                    
                    if (positive > negative) {
                        marketSentiment = 'ä¹è§‚';
                    } else if (negative > positive) {
                        marketSentiment = 'è°¨æ…';
                    }
                }

                // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
                document.getElementById('totalNews').textContent = totalNews;
                document.getElementById('totalAnnouncements').textContent = totalAnnouncements;
                document.getElementById('marketSentiment').textContent = marketSentiment;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('zh-CN');

            } catch (error) {
                console.error('åŠ è½½å¸‚åœºç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        async function loadMarketNews() {
            try {
                const newsApiBase = 'http://localhost:5007';
                const response = await fetch(`${newsApiBase}/api/market-news?days=3&limit=10`);
                const data = await response.json();

                const newsContainer = document.getElementById('newsTabContent');

                if (data.success && data.market_news && data.market_news.length > 0) {
                    newsContainer.innerHTML = data.market_news.map(news => {
                        const sentimentColor = news.sentiment === 'positive' ? '#22c55e' : 
                                             news.sentiment === 'negative' ? '#ef4444' : '#6b7280';
                        const sentimentText = news.sentiment === 'positive' ? 'åˆ©å¥½' :
                                            news.sentiment === 'negative' ? 'åˆ©ç©º' : 'ä¸­æ€?;
                        
                        return `
                            <div class="news-item" onclick="showNewsDetail(${JSON.stringify(news)})">
                                <div class="item-title">${news.title}</div>
                                <div class="item-meta">
                                    <span>${news.source || 'è´¢ç»èµ„è®¯'} â€?${formatTime(news.publish_date)}</span>
                                    <span class="sentiment" style="background: ${sentimentColor}20; color: ${sentimentColor};">${sentimentText}</span>
                                    ${news.source_url ? `<a href="${news.source_url}" target="_blank" onclick="event.stopPropagation()" style="color: #667eea; text-decoration: none;">ğŸ”— åŸæ–‡</a>` : ''}
                                </div>
                                ${news.deepseek_analysis ? `
                                    <div class="ai-analysis" style="margin-top: 8px; padding: 8px; background: #f8fafc; border-radius: 4px; font-size: 12px; color: #4a5568;">
                                        <span style="color: #667eea; font-weight: 500;">ğŸ¤– AIè§£è¯»ï¼?/span>
                                        ${news.deepseek_analysis.analysis}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    newsContainer.innerHTML = `
                        <div style="text-align: center; color: #718096; padding: 30px; font-size: 14px;">
                            ğŸ“° æš‚æ— æœ€æ–°æ–°é—?br>
                            <small style="font-size: 12px;">æ•°æ®æ›´æ–°ä¸?..</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½æ–°é—»å¤±è´¥:', error);
                document.getElementById('newsTabContent').innerHTML = `
                    <div style="text-align: center; color: #ef4444; padding: 30px; font-size: 14px;">
                        âš ï¸ åŠ è½½æ–°é—»å¤±è´¥<br>
                        <small style="font-size: 12px;">è¯·ç¨åé‡è¯?/small>
                    </div>
                `;
            }
        }

        async function loadAnnouncements() {
            try {
                const newsApiBase = 'http://localhost:5007';
                // è·å–ç”¨æˆ·è®¢é˜…çš„è‚¡ç¥¨å…¬å‘?
                const subscriptions = subscriptionManager ? subscriptionManager.subscriptions : [];
                
                if (subscriptions.length === 0) {
                    document.getElementById('announcementsTabContent').innerHTML = `
                        <div style="text-align: center; color: #718096; padding: 30px; font-size: 14px;">
                            ğŸ“‹ æš‚æ— è®¢é˜…è‚¡ç¥¨<br>
                            <small style="font-size: 12px;">è¯·å…ˆæ·»åŠ è®¢é˜…è‚¡ç¥¨ä»¥æŸ¥çœ‹ç›¸å…³å…¬å‘?/small>
                        </div>
                    `;
                    return;
                }
                
                const symbols = subscriptions.slice(0, 8).map(sub => sub.symbol); // é™åˆ¶æœ€å¤?ä¸ªè‚¡ç¥¨é¿å…è¯·æ±‚è¿‡å¤?
                const promises = symbols.map(symbol => 
                    fetch(`${newsApiBase}/api/announcements/${symbol}?days=7&limit=3`)
                        .then(res => res.json())
                        .catch(() => ({ success: false }))
                );

                const results = await Promise.all(promises);
                let allAnnouncements = [];

                results.forEach((data, index) => {
                    if (data.success && data.announcements) {
                        const symbolAnnouncements = data.announcements.map(ann => ({
                            ...ann,
                            symbol: symbols[index]
                        }));
                        allAnnouncements.push(...symbolAnnouncements);
                    }
                });

                // æŒ‰é‡è¦æ€§å’Œæ—¶é—´æ’åº
                allAnnouncements.sort((a, b) => {
                    const importanceDiff = (b.importance_level || 1) - (a.importance_level || 1);
                    if (importanceDiff !== 0) return importanceDiff;
                    return new Date(b.publish_date) - new Date(a.publish_date);
                });

                // åªæ˜¾ç¤ºå‰10æ?
                allAnnouncements = allAnnouncements.slice(0, 10);

                const announcementsContainer = document.getElementById('announcementsTabContent');

                if (allAnnouncements.length > 0) {
                    announcementsContainer.innerHTML = allAnnouncements.map(ann => {
                        const importanceLevel = ann.importance_level >= 4 ? 'high' : 
                                              ann.importance_level >= 3 ? 'medium' : 'low';
                        const importanceColor = importanceLevel === 'high' ? '#ef4444' :
                                              importanceLevel === 'medium' ? '#f59e0b' : '#6b7280';
                        const importanceText = importanceLevel === 'high' ? 'é‡è¦' :
                                             importanceLevel === 'medium' ? 'ä¸€èˆ? : 'æ™®é€?;
                        
                        return `
                            <div class="announcement-item" onclick="showAnnouncementDetail(${JSON.stringify(ann)})">
                                <div class="item-title">[${ann.symbol}] ${ann.title}</div>
                                <div class="item-meta">
                                    <span>${ann.announcement_type || 'ä¼ä¸šå…¬å‘Š'} â€?${formatTime(ann.publish_date)}</span>
                                    <span class="importance-badge" style="background: ${importanceColor}20; color: ${importanceColor};">${importanceText}</span>
                                    ${ann.source_url ? `<a href="${ann.source_url}" target="_blank" onclick="event.stopPropagation()" style="color: #667eea; text-decoration: none;">ğŸ”— åŸæ–‡</a>` : ''}
                                </div>
                                ${ann.deepseek_analysis ? `
                                    <div class="ai-analysis" style="margin-top: 8px; padding: 8px; background: #f8fafc; border-radius: 4px; font-size: 12px; color: #4a5568;">
                                        <span style="color: #667eea; font-weight: 500;">ğŸ¤– AIè§£è¯»ï¼?/span>
                                        ${ann.deepseek_analysis.analysis}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    announcementsContainer.innerHTML = `
                        <div style="text-align: center; color: #718096; padding: 30px; font-size: 14px;">
                            ğŸ“„ æš‚æ— é‡è¦å…¬å‘Š<br>
                            <small style="font-size: 12px;">æ•°æ®æ›´æ–°ä¸?..</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½å…¬å‘Šå¤±è´¥:', error);
                document.getElementById('announcementsTabContent').innerHTML = `
                    <div style="text-align: center; color: #ef4444; padding: 30px; font-size: 14px;">
                        âš ï¸ åŠ è½½å…¬å‘Šå¤±è´¥<br>
                        <small style="font-size: 12px;">è¯·ç¨åé‡è¯?/small>
                    </div>
                `;
            }
        }

        function switchNewsTab(tab) {
            currentNewsTab = tab;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tab) {
                    btn.classList.add('active');
                }
            });
            
            // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
            const newsTab = document.getElementById('newsTabContent');
            const announcementsTab = document.getElementById('announcementsTabContent');
            
            if (tab === 'news') {
                newsTab.style.display = 'block';
                announcementsTab.style.display = 'none';
                loadMarketNews();
            } else {
                newsTab.style.display = 'none';
                announcementsTab.style.display = 'block';
                loadAnnouncements();
            }
        }

        function showNewsDetail(newsData) {
            const analysis = newsData.deepseek_analysis ? 
                `\n\nğŸ¤– AIè§£è¯»ï¼š\n${newsData.deepseek_analysis.analysis}\nï¼ˆåˆ†ææ–¹ï¼?{newsData.deepseek_analysis.analyzed_by}ï¼‰` : '';
            
            const sourceLink = newsData.source_url ? `\n\nğŸ”— åŸæ–‡é“¾æ¥ï¼?{newsData.source_url}` : '';
            
            alert(`æ–°é—»è¯¦æƒ…ï¼š\n\n${newsData.title}\n\n${newsData.content || 'è¯¦ç»†å†…å®¹è¯·æŸ¥çœ‹åŸæ–?}${analysis}${sourceLink}`);
        }

        function showAnnouncementDetail(announcementData) {
            const analysis = announcementData.deepseek_analysis ? 
                `\n\nğŸ¤– AIè§£è¯»ï¼š\n${announcementData.deepseek_analysis.analysis}\nï¼ˆåˆ†ææ–¹ï¼?{announcementData.deepseek_analysis.analyzed_by}ï¼‰` : '';
            
            const sourceLink = announcementData.source_url ? `\n\nğŸ”— åŸæ–‡é“¾æ¥ï¼?{announcementData.source_url}` : '';
            
            alert(`å…¬å‘Šè¯¦æƒ…ï¼š\n\n[${announcementData.symbol}] ${announcementData.title}\n\n${announcementData.content || 'è¯¦ç»†å†…å®¹è¯·æŸ¥çœ‹åŸæ–?}${analysis}${sourceLink}`);
        }

        async function refreshNewsData() {
            const refreshBtn = event.target;
            const originalText = refreshBtn.textContent;
            
            refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°ä¸?..';
            refreshBtn.disabled = true;

            try {
                await Promise.all([
                    loadMarketStats(),
                    currentNewsTab === 'news' ? loadMarketNews() : loadAnnouncements()
                ]);
                
                refreshBtn.textContent = 'âœ?åˆ·æ–°å®Œæˆ';
                setTimeout(() => {
                    refreshBtn.textContent = originalText;
                    refreshBtn.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
                refreshBtn.textContent = 'â?åˆ·æ–°å¤±è´¥';
                setTimeout(() => {
                    refreshBtn.textContent = originalText;
                    refreshBtn.disabled = false;
                }, 2000);
            }
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'æœªçŸ¥æ—¶é—´';
            
            try {
                const date = new Date(timestamp);
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    return 'ä»Šå¤©';
                } else if (diffDays === 1) {
                    return 'æ˜¨å¤©';
                } else if (diffDays < 7) {
                    return `${diffDays}å¤©å‰`;
                } else {
                    return date.toLocaleDateString('zh-CN');
                }
            } catch (e) {
                return 'æœªçŸ¥æ—¶é—´';
            }
        }

        function handleNavbarSearch(event) {
            if (event.key === 'Enter') {
                addFromNavbar();
            }
        }

        function handleQuickSearch(event) {
            if (event.key === 'Enter') {
                addFromQuick();
            }
        }

        function getMockStocks() {
            return [
                // é“¶è¡Œä¸?
                {symbol: '000001', name: 'å¹³å®‰é“¶è¡Œ'},
                {symbol: '600036', name: 'æ‹›å•†é“¶è¡Œ'},
                {symbol: '601166', name: 'å…´ä¸šé“¶è¡Œ'},
                {symbol: '000002', name: 'ä¸‡ç§‘A'},
                {symbol: '601398', name: 'å·¥å•†é“¶è¡Œ'},
                {symbol: '601939', name: 'å»ºè®¾é“¶è¡Œ'},
                {symbol: '601288', name: 'å†œä¸šé“¶è¡Œ'},
                {symbol: '600000', name: 'æµ¦å‘é“¶è¡Œ'},
                {symbol: '002142', name: 'å®æ³¢é“¶è¡Œ'},
                {symbol: '600015', name: 'åå¤é“¶è¡Œ'},
                
                // ä¿é™©
                {symbol: '601318', name: 'ä¸­å›½å¹³å®‰'},
                {symbol: '601601', name: 'ä¸­å›½å¤ªä¿'},
                {symbol: '601319', name: 'ä¸­å›½äººä¿'},
                {symbol: '002797', name: 'ç¬¬ä¸€åˆ›ä¸š'},
                
                // ç™½é…’é£Ÿå“
                {symbol: '600519', name: 'è´µå·èŒ…å°'},
                {symbol: '000858', name: 'äº”ç²®æ¶?},
                {symbol: '000568', name: 'æ³¸å·è€çª–'},
                {symbol: '000596', name: 'å¤äº•è´¡é…’'},
                {symbol: '002304', name: 'æ´‹æ²³è‚¡ä»½'},
                {symbol: '000799', name: 'é…’é¬¼é…?},
                {symbol: '603589', name: 'å£å­çª?},
                {symbol: '000860', name: 'é¡ºé‘«å†œä¸š'},
                {symbol: '002415', name: 'æµ·å¤©å‘³ä¸š'},
                {symbol: '600887', name: 'ä¼Šåˆ©è‚¡ä»½'},
                
                // æ–°èƒ½æºæ±½è½?
                {symbol: '002594', name: 'æ¯”äºšè¿?},
                {symbol: '300750', name: 'å®å¾·æ—¶ä»£'},
                {symbol: '002466', name: 'å¤©é½é”‚ä¸š'},
                {symbol: '002460', name: 'èµ£é”‹é”‚ä¸š'},
                {symbol: '300014', name: 'äº¿çº¬é”‚èƒ½'},
                {symbol: '002812', name: 'æ©æ·è‚¡ä»½'},
                {symbol: '300207', name: 'æ¬£æ—ºè¾?},
                {symbol: '300438', name: 'é¹è¾‰èƒ½æº'},
                {symbol: '600884', name: 'æ‰æ‰è‚¡ä»½'},
                
                // ç§‘æŠ€è‚?
                {symbol: '000063', name: 'ä¸­å…´é€šè®¯'},
                {symbol: '002415', name: 'æµ·åº·å¨è§†'},
                {symbol: '002230', name: 'ç§‘å¤§è®¯é£'},
                {symbol: '300496', name: 'ä¸­ç§‘åˆ›è¾¾'},
                {symbol: '000977', name: 'æµªæ½®ä¿¡æ¯'},
                {symbol: '002837', name: 'è‹±ç»´å…?},
                {symbol: '300413', name: 'èŠ’æœè¶…åª’'},
                {symbol: '002475', name: 'ç«‹è®¯ç²¾å¯†'},
                {symbol: '000100', name: 'TCLç§‘æŠ€'},
                {symbol: '000725', name: 'äº¬ä¸œæ–¹A'},
                
                // åŠå¯¼ä½“èŠ¯ç‰?
                {symbol: '688981', name: 'ä¸­èŠ¯å›½é™…'},
                {symbol: '002049', name: 'ç´«å…‰å›½å¾®'},
                {symbol: '002371', name: 'åŒ—æ–¹ååˆ›'},
                {symbol: '300782', name: 'å“èƒœå¾?},
                {symbol: '688187', name: 'æ—¶ä»£ç”µæ°”'},
                {symbol: '300661', name: 'åœ£é‚¦è‚¡ä»½'},
                {symbol: '603986', name: 'å…†æ˜“åˆ›æ–°'},
                {symbol: '002129', name: 'ä¸­ç¯è‚¡ä»½'},
                {symbol: '300316', name: 'æ™¶ç››æœºç”µ'},
                {symbol: '688396', name: 'åæ¶¦å¾?},
                
                // åŒ»è¯åŒ»ç–—
                {symbol: '300760', name: 'è¿ˆç‘åŒ»ç–—'},
                {symbol: '600276', name: 'æ’ç‘åŒ»è¯'},
                {symbol: '000661', name: 'é•¿æ˜¥é«˜æ–°'},
                {symbol: '300347', name: 'æ³°æ ¼åŒ»è¯'},
                {symbol: '002821', name: 'å‡¯è±è‹?},
                {symbol: '300015', name: 'çˆ±å°”çœ¼ç§‘'},
                {symbol: '300122', name: 'æ™ºé£ç”Ÿç‰©'},
                {symbol: '002007', name: 'åå…°ç”Ÿç‰©'},
                {symbol: '600161', name: 'å¤©å›ç”Ÿç‰©'},
                {symbol: '300529', name: 'å¥å¸†ç”Ÿç‰©'},
                
                // å…‰ä¼æ–°èƒ½æº?
                {symbol: '688599', name: 'å¤©åˆå…‰èƒ½'},
                {symbol: '002459', name: 'æ™¶æ¾³ç§‘æŠ€'},
                {symbol: '300274', name: 'é˜³å…‰ç”µæº'},
                {symbol: '002506', name: 'åé‘«é›†æˆ'},
                {symbol: '300450', name: 'å…ˆå¯¼æ™ºèƒ½'},
                {symbol: '300124', name: 'æ±‡å·æŠ€æœ?},
                {symbol: '002709', name: 'å¤©èµææ–™'},
                {symbol: '300438', name: 'é¹è¾‰èƒ½æº'},
                
                // æˆ¿åœ°äº§å»ºæ?
                {symbol: '000002', name: 'ä¸‡ç§‘A'},
                {symbol: '000001', name: 'å¹³å®‰é“¶è¡Œ'},
                {symbol: '002271', name: 'ä¸œæ–¹é›¨è™¹'},
                {symbol: '000402', name: 'é‡‘èè¡?},
                {symbol: '600048', name: 'ä¿åˆ©å‘å±•'},
                {symbol: '001979', name: 'æ‹›å•†è›‡å£'},
                {symbol: '000069', name: 'åä¾¨åŸA'},
                
                // æ¶ˆè´¹ç”µå­
                {symbol: '002475', name: 'ç«‹è®¯ç²¾å¯†'},
                {symbol: '300433', name: 'è“æ€ç§‘æŠ€'},
                {symbol: '002241', name: 'æ­Œå°”è‚¡ä»½'},
                {symbol: '000725', name: 'äº¬ä¸œæ–¹A'},
                {symbol: '000100', name: 'TCLç§‘æŠ€'},
                {symbol: '002456', name: 'æ¬§è²å…?},
                
                // å·¥ä¸šåˆ¶é€?
                {symbol: '002714', name: 'ç‰§åŸè‚¡ä»½'},
                {symbol: '300124', name: 'æ±‡å·æŠ€æœ?},
                {symbol: '002236', name: 'å¤§åè‚¡ä»½'},
                {symbol: '600031', name: 'ä¸‰ä¸€é‡å·¥'},
                {symbol: '000425', name: 'å¾å·¥æœºæ¢°'},
                {symbol: '002352', name: 'é¡ºä¸°æ§è‚¡'},
                
                // å†›å·¥èˆªå¤©
                {symbol: '600893', name: 'èˆªå‘åŠ¨åŠ›'},
                {symbol: '002179', name: 'ä¸­èˆªå…‰ç”µ'},
                {symbol: '000768', name: 'ä¸­èˆªé£æœº'},
                {symbol: '600760', name: 'ä¸­èˆªæ²ˆé£'},
                {symbol: '002013', name: 'ä¸­èˆªæœºç”µ'},
                
                // åˆ¸å•†
                {symbol: '300059', name: 'ä¸œæ–¹è´¢å¯Œ'},
                {symbol: '000166', name: 'ç”³ä¸‡å®æº'},
                {symbol: '601688', name: 'åæ³°è¯åˆ¸'},
                {symbol: '600030', name: 'ä¸­ä¿¡è¯åˆ¸'},
                {symbol: '000776', name: 'å¹¿å‘è¯åˆ¸'},
                
                // æœ‰è‰²é‡‘å±
                {symbol: '600362', name: 'æ±Ÿè¥¿é“œä¸š'},
                {symbol: '601899', name: 'ç´«é‡‘çŸ¿ä¸š'},
                {symbol: '600547', name: 'å±±ä¸œé»„é‡‘'},
                {symbol: '002460', name: 'èµ£é”‹é”‚ä¸š'},
                {symbol: '000831', name: 'äº”çŸ¿ç¨€åœ?},
                {symbol: '600111', name: 'åŒ—æ–¹ç¨€åœ?},
                {symbol: '002466', name: 'å¤©é½é”‚ä¸š'},
                
                // åŒ–å·¥
                {symbol: '002709', name: 'å¤©èµææ–™'},
                {symbol: '300596', name: 'åˆ©å®‰éš?},
                {symbol: '600309', name: 'ä¸‡ååŒ–å­¦'},
                {symbol: '000792', name: 'ç›æ¹–è‚¡ä»½'},
                
                // ä¼ åª’å¨±ä¹
                {symbol: '300413', name: 'èŠ’æœè¶…åª’'},
                {symbol: '002555', name: 'ä¸‰ä¸ƒäº’å¨±'},
                {symbol: '300251', name: 'å…‰çº¿ä¼ åª’'},
                {symbol: '002624', name: 'å®Œç¾ä¸–ç•Œ'},
                
                // å†œæ—ç‰§æ¸”
                {symbol: '002714', name: 'ç‰§åŸè‚¡ä»½'},
                {symbol: '000876', name: 'æ–°å¸Œæœ?},
                {symbol: '002311', name: 'æµ·å¤§é›†å›¢'},
                {symbol: '000895', name: 'åŒæ±‡å‘å±•'},
                
                // äº¤é€šè¿è¾?
                {symbol: '002352', name: 'é¡ºä¸°æ§è‚¡'},
                {symbol: '600009', name: 'ä¸Šæµ·æœºåœº'},
                {symbol: '000089', name: 'æ·±åœ³æœºåœº'},
                {symbol: '600115', name: 'ä¸œæ–¹èˆªç©º'},
                
                // å…¬ç”¨äº‹ä¸š
                {symbol: '600886', name: 'å›½æŠ•ç”µåŠ›'},
                {symbol: '000027', name: 'æ·±åœ³èƒ½æº'},
                {symbol: '600795', name: 'å›½ç”µç”µåŠ›'},
                
                // é’¢é“æœ‰è‰²
                {symbol: '600019', name: 'å®é’¢è‚¡ä»½'},
                {symbol: '000708', name: 'ä¸­ä¿¡ç‰¹é’¢'},
                {symbol: '002756', name: 'æ°¸å…´ææ–™'},
                
                // çŸ³æ²¹åŒ–å·¥
                {symbol: '600028', name: 'ä¸­å›½çŸ³åŒ–'},
                {symbol: '601857', name: 'ä¸­å›½çŸ³æ²¹'},
                {symbol: '600346', name: 'æ’åŠ›çŸ³åŒ–'},
                
                // é›¶å”®å•†è´¸
                {symbol: '000858', name: 'äº”ç²®æ¶?},
                {symbol: '002024', name: 'è‹å®æ˜“è´­'},
                {symbol: '000001', name: 'å¹³å®‰é“¶è¡Œ'},
                
                // ETFåŸºé‡‘
                {symbol: '510300', name: 'æ²ªæ·±300ETF'},
                {symbol: '159919', name: 'æ²ªæ·±300ETF'},
                {symbol: '510500', name: 'ä¸­è¯500ETF'},
                {symbol: '159922', name: 'ä¸­è¯500ETF'},
                {symbol: '588000', name: 'ç§‘åˆ›50ETF'},
                {symbol: '159858', name: 'ç§‘åˆ›50ETF'},
                {symbol: '588080', name: 'ç§‘åˆ›æ¿ETF'},
                {symbol: '159781', name: 'ç§‘åˆ›æ¿ETF'},
                {symbol: '510050', name: 'ä¸Šè¯50ETF'},
                {symbol: '159901', name: 'æ·±è¯100ETF'},
                {symbol: '512690', name: 'é…’ETF'},
                {symbol: '515790', name: 'å…‰ä¼ETF'},
                {symbol: '516160', name: 'æ–°èƒ½æºETF'},
                {symbol: '512480', name: 'åŠå¯¼ä½“ETF'},
                {symbol: '159995', name: 'èŠ¯ç‰‡ETF'},
                {symbol: '512170', name: 'åŒ»ç–—ETF'},
                {symbol: '159928', name: 'æ¶ˆè´¹ETF'},
                {symbol: '512880', name: 'è¯åˆ¸ETF'},
                {symbol: '512800', name: 'é“¶è¡ŒETF'},
                {symbol: '515050', name: '5GETF'},
                {symbol: '159870', name: 'æœ‰è‰²é‡‘å±ETF'},
                {symbol: '515220', name: 'ç…¤ç‚­ETF'},
                {symbol: '159825', name: 'æˆé•¿ETF'},
                {symbol: '510630', name: 'é’¢é“ETF'},
                {symbol: '512660', name: 'å†›å·¥ETF'},
                {symbol: '515030', name: 'æ–°èƒ½æºè½¦ETF'},
                {symbol: '159806', name: 'æ’ç”Ÿç§‘æŠ€ETF'},
                {symbol: '513100', name: 'çº³æ–¯è¾¾å…‹100ETF'},
                
                // å…¶ä»–é‡è¦ä¸ªè‚¡
                {symbol: '000651', name: 'æ ¼åŠ›ç”µå™¨'},
                {symbol: '000333', name: 'ç¾çš„é›†å›¢'},
                {symbol: '002008', name: 'å¤§æ—æ¿€å…?},
                {symbol: '300003', name: 'ä¹æ™®åŒ»ç–—'},
                {symbol: '002202', name: 'é‡‘é£ç§‘æŠ€'},
                {symbol: '600958', name: 'ä¸œæ–¹è¯åˆ¸'},
                {symbol: '002138', name: 'é¡ºç»œç”µå­'},
                {symbol: '300408', name: 'ä¸‰ç¯é›†å›¢'},
                {symbol: '000338', name: 'æ½æŸ´åŠ¨åŠ›'},
                {symbol: '002463', name: 'æ²ªç”µè‚¡ä»½'},
                {symbol: '002841', name: 'è§†æºè‚¡ä»½'},
                {symbol: '688303', name: 'å¤§å…¨èƒ½æº'},
                {symbol: '600703', name: 'ä¸‰å®‰å…‰ç”µ'},
                {symbol: '002050', name: 'ä¸‰èŠ±æ™ºæ§'},
                {symbol: '300782', name: 'å“èƒœå¾?},
                {symbol: '002568', name: 'ç™¾æ¶¦è‚¡ä»½'},
                {symbol: '600183', name: 'ç”Ÿç›Šç§‘æŠ€'},
                {symbol: '300628', name: 'äº¿è”ç½‘ç»œ'},
                {symbol: '300347', name: 'æ³°æ ¼åŒ»è¯'},
                {symbol: '300999', name: 'é‡‘é¾™é±?},
                {symbol: '002142', name: 'å®æ³¢é“¶è¡Œ'},
                {symbol: '600009', name: 'ä¸Šæµ·æœºåœº'},
                {symbol: '600104', name: 'ä¸Šæ±½é›†å›¢'},
                {symbol: '000858', name: 'äº”ç²®æ¶?},
                {symbol: '300316', name: 'æ™¶ç››æœºç”µ'},
                {symbol: '688271', name: 'è”å½±åŒ»ç–—'},
                {symbol: '300450', name: 'å…ˆå¯¼æ™ºèƒ½'},
                {symbol: '300760', name: 'è¿ˆç‘åŒ»ç–—'}
            ];
        }

        function showQuickSuggestions(query) {
            const suggestions = document.getElementById('quickSuggestions');
            
            if (!query || query.length < 1) {
                suggestions.style.display = 'none';
                return;
            }

            const mockStocks = getMockStocks();
            const filtered = mockStocks.filter(stock => 
                stock.symbol.includes(query) || 
                stock.name.includes(query)
            ).slice(0, 5); // æœ€å¤šæ˜¾ç¤?ä¸ªå»ºè®?

            if (filtered.length === 0) {
                suggestions.style.display = 'none';
                return;
            }

            suggestions.innerHTML = filtered.map(stock => `
                <div class="navbar-suggestion-item" onclick="selectQuickSuggestion('${stock.symbol}', '${stock.name}')">
                    <div class="navbar-suggestion-code">${stock.symbol}</div>
                    <div class="navbar-suggestion-name">${stock.name}</div>
                </div>
            `).join('');

            suggestions.style.display = 'block';
        }

        function selectQuickSuggestion(symbol, name) {
            subscriptionManager.addSubscription(symbol, name);
            document.getElementById('quickStockInput').value = '';
            document.getElementById('quickSuggestions').style.display = 'none';
        }

        function showNavbarSuggestions(query) {
            const suggestions = document.getElementById('navbarSuggestions');
            
            if (!suggestions) return; // å¦‚æœå…ƒç´ ä¸å­˜åœ¨å°±è¿”å›
            
            if (!query || query.length < 1) {
                suggestions.style.display = 'none';
                return;
            }

            const mockStocks = getMockStocks();
            const filtered = mockStocks.filter(stock => 
                stock.symbol.includes(query) || 
                stock.name.includes(query)
            ).slice(0, 5);

            if (filtered.length === 0) {
                suggestions.style.display = 'none';
                return;
            }

            suggestions.innerHTML = filtered.map(stock => `
                <div class="navbar-suggestion-item" onclick="selectNavbarSuggestion('${stock.symbol}', '${stock.name}')">
                    <div class="navbar-suggestion-code">${stock.symbol}</div>
                    <div class="navbar-suggestion-name">${stock.name}</div>
                </div>
            `).join('');

            suggestions.style.display = 'block';
        }

        function selectNavbarSuggestion(symbol, name) {
            subscriptionManager.addSubscription(symbol, name);
            const input = document.getElementById('navbarStockInput');
            const suggestions = document.getElementById('navbarSuggestions');
            if (input) input.value = '';
            if (suggestions) suggestions.style.display = 'none';
        }

        function addFromQuick() {
            const input = document.getElementById('quickStockInput');
            const query = input.value.trim();
            
            if (!query) {
                subscriptionManager.showNotification('âš ï¸ æç¤º', 'è¯·è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°');
                return;
            }

            const mockStocks = getMockStocks();
            const found = mockStocks.find(stock => 
                stock.symbol.includes(query) || 
                stock.name.includes(query)
            );

            if (found) {
                subscriptionManager.addSubscription(found.symbol, found.name);
                input.value = '';
                document.getElementById('quickSuggestions').style.display = 'none';
            } else {
                subscriptionManager.showNotification('â?æœªæ‰¾åˆ?, 'æœªæ‰¾åˆ°åŒ¹é…çš„è‚¡ç¥¨ï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç æˆ–åç§°');
            }
        }

        function addFromNavbar() {
            const input = document.getElementById('navbarStockInput');
            if (!input) return;
            
            const query = input.value.trim();
            
            if (!query) {
                subscriptionManager.showNotification('âš ï¸ æç¤º', 'è¯·è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°');
                return;
            }

            const mockStocks = getMockStocks();
            const found = mockStocks.find(stock => 
                stock.symbol.includes(query) || 
                stock.name.includes(query)
            );

            if (found) {
                subscriptionManager.addSubscription(found.symbol, found.name);
                input.value = '';
                const suggestions = document.getElementById('navbarSuggestions');
                if (suggestions) suggestions.style.display = 'none';
            } else {
                subscriptionManager.showNotification('â?æœªæ‰¾åˆ?, 'æœªæ‰¾åˆ°åŒ¹é…çš„è‚¡ç¥¨ï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç æˆ–åç§°');
            }
        }

        // ç”Ÿæˆæ™ºèƒ½ç®€æŠ?- å¤ç”¨AI-Traderçš„å¸‚åœºæ‰«ææ–¹æ³?
        async function generateWeeklyReport() {
            const reportContent = document.getElementById('reportContent');
            const subscriptions = subscriptionManager.subscriptions;
            
            if (subscriptions.length === 0) {
                subscriptionManager.showNotification('âš ï¸ æç¤º', 'è¯·å…ˆæ·»åŠ è®¢é˜…è‚¡ç¥¨å†ç”Ÿæˆç®€æŠ?);
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€?
            reportContent.innerHTML = `
                <div class="report-loading">
                    ğŸ¤– AIæ­£åœ¨åˆ†æå¸‚åœºä¿¡æ¯ï¼Œæ”¶é›†æœ¬å‘¨è‚¡ç¥¨åŠ¨æ€?..<br>
                    <small>é¢„è®¡éœ€è¦?0-60ç§’ï¼Œæ­£åœ¨è°ƒç”¨çœŸå®æ•°æ®æº?/small>
                </div>
            `;

            try {
                // è°ƒç”¨åç«¯APIç”ŸæˆçœŸå®ç®€æŠ?
                const reportData = await callRealReportAPI(subscriptions);
                
                // æ˜¾ç¤ºç”Ÿæˆçš„ç®€æŠ?
                displayReport(reportData);
                
                subscriptionManager.showNotification('âœ?ç®€æŠ¥ç”Ÿæˆå®Œæˆ?, 'æœ¬å‘¨æ™ºèƒ½ç®€æŠ¥å·²æ›´æ–°');
                
            } catch (error) {
                console.error('ç®€æŠ¥ç”Ÿæˆé”™è¯?', error);
                // å¦‚æœçœŸå®APIå¤±è´¥ï¼Œå›é€€åˆ°æ¨¡æ‹Ÿæ•°æ?
                try {
                    const fallbackData = await generateMockReport(subscriptions);
                    displayReport(fallbackData);
                    subscriptionManager.showNotification('âš ï¸ ç®€æŠ¥ç”Ÿæˆå®Œæˆ?, 'å·²ä½¿ç”¨æ¼”ç¤ºæ•°æ®ç”Ÿæˆç®€æŠ?);
                } catch (fallbackError) {
                    reportContent.innerHTML = `
                        <div class="empty-report">
                            â?ç®€æŠ¥ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯?br>
                            <small>é”™è¯¯ä¿¡æ¯: ${error.message}</small>
                        </div>
                    `;
                    subscriptionManager.showNotification('â?ç”Ÿæˆå¤±è´¥', 'ç®€æŠ¥ç”Ÿæˆå‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯?);
                }
            }
        }

        // è°ƒç”¨çœŸå®çš„ç®€æŠ¥ç”ŸæˆAPI - å¤ç”¨AI-Traderæ¶æ„
        async function callRealReportAPI(subscriptions) {
            const apiBase = 'http://localhost:5002'; // ä½¿ç”¨ç‹¬ç«‹çš„ä»·æ ¼æœåŠ?
            
            // æ„å»ºè¯·æ±‚æ•°æ®
            const requestData = {
                stocks: subscriptions.map(sub => sub.symbol),
                action: 'generate_weekly_report',
                date_range: {
                    start_date: getWeekStartDate(),
                    end_date: getCurrentDate()
                }
            };

            try {
                // 1. é¦–å…ˆæ”¶é›†è‚¡ç¥¨ä»·æ ¼æ•°æ®
                const priceData = await fetchStockPrices(requestData.stocks);
                
                // 2. æ”¶é›†å¸‚åœºæ–°é—»å’Œä¿¡æ?
                const marketInfo = await fetchMarketInformation(requestData.stocks);
                
                // 3. è°ƒç”¨AIåˆ†ææœåŠ¡
                const analysisResult = await analyzeMarketData({
                    priceData,
                    marketInfo,
                    subscriptions: subscriptions
                });

                return analysisResult;
                
            } catch (error) {
                console.error('çœŸå®APIè°ƒç”¨å¤±è´¥:', error);
                throw error;
            }
        }

        // è·å–è‚¡ç¥¨ä»·æ ¼æ•°æ® - è°ƒç”¨è…¾è®¯è´¢ç»API
        async function fetchStockPrices(symbols) {
            const prices = {};
            
            try {
                // æ‰¹é‡è·å–è‚¡ç¥¨ä»·æ ¼æ•°æ®
                const response = await fetch('http://localhost:5002/api/stocks', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbols: symbols.slice(0, 10) // é™åˆ¶æ•°é‡é¿å…è¶…æ—¶
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    for (const [symbol, data] of Object.entries(result)) {
                        if (!data.error) {
                            prices[symbol] = data;
                            console.log(`æˆåŠŸè·å–${symbol}ä»·æ ¼:`, data);
                        } else {
                            console.log(`è·å–${symbol}ä»·æ ¼å¤±è´¥:`, data.error);
                        }
                    }
                } else {
                    console.error('æ‰¹é‡è·å–ä»·æ ¼å¤±è´¥:', response.status);
                    // å¦‚æœæ‰¹é‡å¤±è´¥ï¼Œå°è¯•é€ä¸ªè·å–
                    for (const symbol of symbols.slice(0, 5)) {
                        try {
                            const singleResponse = await fetch(`http://localhost:5002/api/stock/${symbol}`);
                            if (singleResponse.ok) {
                                const data = await singleResponse.json();
                                if (!data.error) {
                                    prices[symbol] = data;
                                    console.log(`æˆåŠŸè·å–${symbol}ä»·æ ¼:`, data);
                                }
                            }
                        } catch (error) {
                            console.log(`è·å–${symbol}ä»·æ ¼å¤±è´¥:`, error);
                        }
                    }
                }
            } catch (error) {
                console.error('ä»·æ ¼æœåŠ¡è¿æ¥å¤±è´¥:', error);
            }
            
            return prices;
        }

        // è·å–å¸‚åœºä¿¡æ¯ - ä½¿ç”¨æ¨¡æ‹Ÿå¸‚åœºåˆ†ææ•°æ®
        async function fetchMarketInformation(symbols) {
            const marketInfo = {
                general: [],
                stockSpecific: {}
            };
            
            try {
                // æ£€æŸ¥å¸‚åœºçŠ¶æ€?
                const marketStatusResponse = await fetch('http://localhost:5002/api/market/status');
                let marketStatus = 'trading';
                if (marketStatusResponse.ok) {
                    const statusData = await marketStatusResponse.json();
                    marketStatus = statusData.status;
                }
                
                // è°ƒç”¨DeepSeek AIè¿›è¡Œå¸‚åœºåˆ†æ (LangChainå¢å¼ºç‰?
                try {
                    // åˆ›å»ºAbortControlleræ¥å¤„ç†è¶…æ—?
                    const marketAbortController = new AbortController();
                    const marketTimeoutId = setTimeout(() => marketAbortController.abort(), 60000); // 60ç§’è¶…æ—?
                    
                    const aiMarketResponse = await fetch('http://localhost:5001/api/langchain/market-analysis', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            market_status: marketStatus,
                            stocks: symbols.slice(0, 5).map(symbol => ({
                                symbol: symbol,
                                name: getStockName(symbol) || symbol
                            })),
                            market_trend: 'éœ‡è¡ä¸Šè¡Œ',
                            liquidity: 'å……è£•',
                            policy_news: 'æ”¿ç­–é¢ç›¸å¯¹å¹³ç¨³ï¼Œå¸‚åœºæµåŠ¨æ€§ä¿æŒåˆç†å……è£?
                        }),
                        signal: marketAbortController.signal
                    });
                    
                    clearTimeout(marketTimeoutId);
                    
                    if (aiMarketResponse.ok) {
                        const aiData = await aiMarketResponse.json();
                        if (aiData.success) {
                            marketInfo.general.push({
                                query: 'ğŸ¤– DeepSeek AIå¸‚åœºåˆ†æ',
                                result: aiData.market_analysis,
                                source: 'deepseek_ai'
                            });
                            console.log('âœ?DeepSeek AIå¸‚åœºåˆ†æè·å–æˆåŠŸ');
                        } else {
                            throw new Error('AIåˆ†æå“åº”å¤±è´¥');
                        }
                    } else {
                        throw new Error(`AIæœåŠ¡å“åº”é”™è¯¯: ${aiMarketResponse.status}`);
                    }
                } catch (aiError) {
                    console.warn('âš ï¸ DeepSeek AIåˆ†æå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿåˆ†æ?', aiError);
                    // é™çº§åˆ°æ¨¡æ‹Ÿåˆ†æ?
                    const fallbackAnalysis = generateMarketAnalysis(marketStatus);
                    marketInfo.general.push({
                        query: 'å¸‚åœºæ€»ä½“åˆ†æ (æ¨¡æ‹Ÿ)',
                        result: fallbackAnalysis,
                        source: 'fallback'
                    });
                }
                
                // ä¸ºä¸ªè‚¡ç”ŸæˆåŸºç¡€ä¿¡æ¯ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ä½œä¸ºè¡¥å……ï¼?
                for (const symbol of symbols.slice(0, 5)) {
                    const stockName = getStockName(symbol) || symbol;
                    const analysis = generateStockAnalysis(symbol, stockName);
                    marketInfo.stockSpecific[symbol] = analysis;
                }
                
                console.log('å¸‚åœºä¿¡æ¯åˆ†æå®Œæˆ');
                
            } catch (error) {
                console.error('è·å–å¸‚åœºä¿¡æ¯å¤±è´¥:', error);
                // å®Œå…¨é™çº§åˆ°æ¨¡æ‹Ÿæ•°æ?
                const fallbackAnalysis = generateMarketAnalysis('unknown');
                marketInfo.general.push({
                    query: 'å¸‚åœºæ€»ä½“åˆ†æ (ç¦»çº¿)',
                    result: fallbackAnalysis,
                    source: 'offline'
                });
            }
            
            return marketInfo;
        }
        
        // ç”Ÿæˆå¸‚åœºåˆ†æ
        function generateMarketAnalysis(marketStatus) {
            const analyses = {
                'trading': 'å¸‚åœºæ­£åœ¨äº¤æ˜“ä¸­ï¼Œæˆäº¤æ´»è·ƒã€‚å»ºè®®å…³æ³¨ç›˜ä¸­å¼‚åŠ¨ï¼ŒæŠŠæ¡çŸ­çº¿æœºä¼šã€?,
                'pre_market': 'å¸‚åœºå³å°†å¼€ç›˜ï¼Œå»ºè®®å…³æ³¨éš”å¤œå¤–ç›˜å½±å“å’Œå¼€ç›˜å‰çš„é‡è¦æ¶ˆæ¯ã€?,
                'after_market': 'å¸‚åœºå·²æ”¶ç›˜ï¼Œå»ºè®®å¤ç›˜ä»Šæ—¥è¡Œæƒ…ï¼Œä¸ºæ˜æ—¥äº¤æ˜“åšå‡†å¤‡ã€?,
                'lunch_break': 'å¸‚åœºåˆä¼‘ä¸­ï¼Œå¯ä»¥å›é¡¾ä¸Šåˆèµ°åŠ¿ï¼Œè°ƒæ•´ä¸‹åˆäº¤æ˜“ç­–ç•¥ã€?,
                'closed': 'å¸‚åœºä¼‘å¸‚ä¸­ï¼Œé€‚åˆè¿›è¡ŒåŸºæœ¬é¢ç ”ç©¶å’Œåˆ¶å®šæŠ•èµ„è®¡åˆ’ã€?
            };
            
            const baseAnalysis = analyses[marketStatus] || 'å¸‚åœºçŠ¶æ€æœªçŸ¥ï¼Œå»ºè®®ä¿æŒè°¨æ…ã€?;
            
            const additionalInsights = [
                'å½“å‰å®è§‚ç¯å¢ƒç›¸å¯¹ç¨³å®šï¼Œæ”¿ç­–é¢æ€»ä½“åæš–ã€?,
                'èµ„é‡‘æµåŠ¨æ€§ä¿æŒåˆç†å……è£•ï¼Œæœ‰åˆ©äºå¸‚åœºä¼°å€¼ä¿®å¤ã€?,
                'å»ºè®®é‡ç‚¹å…³æ³¨ä¸šç»©ç¡®å®šæ€§å¼ºçš„ä¼˜è´¨ä¸ªè‚¡ã€?,
                'æ§åˆ¶ä»“ä½é£é™©ï¼Œé‡‡å–åˆ†æ•£æŠ•èµ„ç­–ç•¥ã€?
            ];
            
            return baseAnalysis + ' ' + additionalInsights[Math.floor(Math.random() * additionalInsights.length)];
        }
        
        // ç”Ÿæˆä¸ªè‚¡åˆ†æ
        function generateStockAnalysis(symbol, name) {
            const sectorAnalysis = {
                // é“¶è¡Œè‚?
                '000001': 'é“¶è¡Œæ¿å—ä¼°å€¼å¤„äºå†å²ä½ä½ï¼Œè‚¡æ¯ç‡è¾ƒé«˜ï¼Œé€‚åˆä»·å€¼æŠ•èµ„è€…ã€?,
                '600036': 'æ‹›å•†é“¶è¡Œèµ„äº§è´¨é‡ä¼˜ç§€ï¼Œç›ˆåˆ©èƒ½åŠ›å¼ºï¼Œæ˜¯é“¶è¡Œæ¿å—çš„ä¼˜è´¨æ ‡çš„ã€?,
                // ç™½é…’è‚?
                '600519': 'è´µå·èŒ…å°å“ç‰Œä»·å€¼çªå‡ºï¼Œé•¿æœŸæŠ•èµ„ä»·å€¼æ˜¾è‘—ï¼ŒçŸ­æœŸå…³æ³¨ä¼°å€¼ä¿®å¤ã€?,
                '000858': 'äº”ç²®æ¶²ä½œä¸ºç™½é…’é¾™å¤´ï¼Œå—ç›Šäºæ¶ˆè´¹å‡çº§è¶‹åŠ¿ã€?,
                // æ–°èƒ½æº?
                '300750': 'å®å¾·æ—¶ä»£åœ¨åŠ¨åŠ›ç”µæ± é¢†åŸŸåœ°ä½ç¨³å›ºï¼Œå…³æ³¨æ–°æŠ€æœ¯çªç ´ã€?,
                '002594': 'æ¯”äºšè¿ªæ–°èƒ½æºæ±½è½¦é”€é‡å¢é•¿å¼ºåŠ²ï¼Œå‚ç›´ä¸€ä½“åŒ–ä¼˜åŠ¿æ˜æ˜¾ã€?
            };
            
            const defaultAnalysis = `${name}åŸºæœ¬é¢ç¨³å¥ï¼Œå»ºè®®æŒç»­å…³æ³¨å…¬å¸ä¸šç»©è¡¨ç°å’Œè¡Œä¸šå‘å±•è¶‹åŠ¿ã€‚`;
            
            return sectorAnalysis[symbol] || defaultAnalysis;
        }

        // AIåˆ†æå¸‚åœºæ•°æ® - åŸºäºçœŸå®æ•°æ®è¿›è¡Œæ™ºèƒ½åˆ†æ
        async function analyzeMarketData({ priceData, marketInfo, subscriptions }) {
            const currentDate = new Date();
            const weekStart = new Date(currentDate.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            // å‡†å¤‡ç”¨äºAIåˆ†æçš„è‚¡ç¥¨æ•°æ?
            const stocksForAI = [];
            for (const subscription of subscriptions.slice(0, 5)) {
                const symbol = subscription.symbol;
                const price = priceData[symbol];
                
                if (price && !price.error) {
                    stocksForAI.push({
                        symbol: symbol,
                        name: subscription.name,
                        current_price: price.current_price || 0,
                        change_percent: price.change_percent || 0,
                        volume: price.volume || 0,
                        market_status: price.market_status || 'unknown',
                        sector: getStockSector(symbol),
                        pe: price.pe || 'N/A',
                        pb: price.pb || 'N/A'
                    });
                }
            }
            
            let stockAnalysis = [];
            let aiAnalysisSuccess = false;
            
            // å°è¯•è°ƒç”¨DeepSeek AIè¿›è¡Œä¸ªè‚¡åˆ†æ
            if (stocksForAI.length > 0) {
                try {
                    console.log('ğŸ¤– è°ƒç”¨DeepSeek AIè¿›è¡Œä¸ªè‚¡åˆ†æ (LangChainå¢å¼ºç‰?...');
                    
                    // åˆ›å»ºAbortControlleræ¥å¤„ç†è¶…æ—?
                    const abortController = new AbortController();
                    const timeoutId = setTimeout(() => abortController.abort(), 60000); // 60ç§’è¶…æ—?
                    
                    const aiStockResponse = await fetch(`http://localhost:5001/api/langchain/stock-analysis?t=${Date.now()}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        },
                        body: JSON.stringify({
                            stocks: stocksForAI
                        }),
                        signal: abortController.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (aiStockResponse.ok) {
                        const aiData = await aiStockResponse.json();
                        console.log('ğŸ” LangChain APIå“åº”:', aiData);
                        if (aiData.success && aiData.results) {
                            // è§£æAIåˆ†æç»“æœ
                            for (const result of aiData.results) {
                                console.log('ğŸ“Š è§£æä¸ªè‚¡åˆ†æç»“æœ:', result.symbol, 'åˆ†æé•¿åº¦:', result.analysis?.length || 0);
                                const parsed = parseAIStockAnalysis(result);
                                console.log('ğŸ“ˆ è§£æåè¯„åˆ?', parsed.score, 'å»ºè®®:', parsed.suggestion);
                                stockAnalysis.push(parsed);
                            }
                            aiAnalysisSuccess = true;
                            console.log('âœ?DeepSeek AIä¸ªè‚¡åˆ†æè·å–æˆåŠŸ');
                        } else {
                            console.warn('âš ï¸ LangChain APIè¿”å›æ ¼å¼å¼‚å¸¸:', aiData);
                        }
                    } else {
                        console.error('â?LangChain APIè¯·æ±‚å¤±è´¥:', aiStockResponse.status, aiStockResponse.statusText);
                    }
                } catch (aiError) {
                    console.warn('âš ï¸ DeepSeek AIä¸ªè‚¡åˆ†æå¤±è´¥:', aiError);
                    // å¦‚æœæ˜¯è¶…æ—¶é”™è¯¯ï¼Œæ˜¾ç¤ºç‰¹æ®Šæç¤º
                    if (aiError.name === 'AbortError') {
                        console.error('ğŸ• LangChain APIå“åº”è¶…æ—¶ (>60ç§?');
                        subscriptionManager.showNotification('âš ï¸ AIåˆ†æè¶…æ—¶', 'DeepSeekåˆ†ææœåŠ¡å“åº”ç¼“æ…¢ï¼Œå°†ä½¿ç”¨åŸºç¡€åˆ†æ');
                    } else {
                        console.error('ğŸ’¥ LangChain APIè°ƒç”¨å¤±è´¥:', aiError.message);
                        subscriptionManager.showNotification('â?AIåˆ†æå¤±è´¥', `é”™è¯¯: ${aiError.message}`);
                    }
                }
            }
            
            // å¦‚æœAIåˆ†æå¤±è´¥ï¼Œé™çº§åˆ°åŸæœ‰åˆ†æé€»è¾‘
            if (!aiAnalysisSuccess) {
                console.log('ğŸ“Š ä½¿ç”¨ä¼ ç»Ÿåˆ†ææ–¹æ³•...');
                for (const subscription of subscriptions.slice(0, 8)) {
                    const symbol = subscription.symbol;
                    const price = priceData[symbol];
                    const stockInfo = marketInfo.stockSpecific[symbol];
                    let analysis = {};
                    
                    if (price && !price.error) {
                        const currentPrice = price.current_price || 0;
                        const changePercent = price.change_percent || 0;
                        
                        let summaryText = `${subscription.name} å½“å‰ä»·æ ¼ Â¥${currentPrice.toFixed(2)}`;
                        if (Math.abs(changePercent) > 0.1) {
                            summaryText += `ï¼Œè¾ƒå¼€ç›?{changePercent > 0 ? 'ä¸Šæ¶¨' : 'ä¸‹è·Œ'}${Math.abs(changePercent).toFixed(2)}%`;
                        }
                        
                        analysis = {
                            symbol: symbol,
                            name: subscription.name,
                            summary: summaryText + `ã€?{generateAnalysisSummary(symbol, changePercent)}`,
                            impact: changePercent > 2 ? 'positive' : (changePercent < -2 ? 'negative' : 'neutral'),
                            impactText: generateImpactText(changePercent),
                            price: {
                                current: currentPrice,
                                change: changePercent,
                                market_status: price.market_status
                            }
                        };
                    } else {
                        analysis = {
                            symbol: symbol,
                            name: subscription.name,
                            summary: `${subscription.name} - å¸‚åœºè¡¨ç°å¹³ç¨³ï¼Œå»ºè®®å…³æ³¨åŸºæœ¬é¢å˜åŒ–`,
                            impact: 'neutral',
                            impactText: 'å»ºè®®æŒç»­å…³æ³¨ç›¸å…³åŠ¨æ€å’Œæ”¿ç­–é¢å˜åŒ?,
                            price: null
                        };
                    }
                    
                    stockAnalysis.push(analysis);
                }
            }
            
            // ç”Ÿæˆå¸‚åœºæ€»ç»“
            let marketSummary = "æœ¬å‘¨Aè‚¡å¸‚åœºè¡¨ç°ç¨³å¥ï¼ŒæŠ•èµ„è€…æƒ…ç»ªè°¨æ…ä¹è§?;
            let dataSourceLabel = "åŸºäºä¼ ç»Ÿåˆ†ææ–¹æ³•";
            
            if (marketInfo.general.length > 0) {
                const generalInfo = marketInfo.general[0];
                if (generalInfo.source === 'deepseek_ai') {
                    marketSummary = generalInfo.result;
                    dataSourceLabel = aiAnalysisSuccess ? "åŸºäºDeepSeek AIæ·±åº¦åˆ†æ" : "åŸºäºDeepSeek AIå¸‚åœºåˆ†æ + ä¼ ç»Ÿä¸ªè‚¡åˆ†æ";
                } else {
                    const combinedInfo = marketInfo.general.map(info => info.result).join(' ');
                    if (combinedInfo.includes('å®½æ¾') || combinedInfo.includes('åˆ©å¥½')) {
                        marketSummary = "æœ¬å‘¨å¸‚åœºåˆ©å¥½å› ç´ å¢å¤šï¼Œæ”¿ç­–ç¯å¢ƒç›¸å¯¹å‹å¥½ï¼Œå¸‚åœºé£é™©åå¥½æœ‰æ‰€æå‡";
                    } else if (combinedInfo.includes('é£é™©') || combinedInfo.includes('è°¨æ…')) {
                        marketSummary = "å¸‚åœºä»å­˜åœ¨ä¸€å®šä¸ç¡®å®šæ€§ï¼ŒæŠ•èµ„è€…ä¿æŒè°¨æ…æ€åº¦ï¼Œå»ºè®®æ§åˆ¶é£é™?;
                    }
                }
            }
            
            const hasRealData = Object.keys(priceData).length > 0 || marketInfo.general.length > 0;
            
            return {
                title: `MarketBrew æ™ºèƒ½ç®€æŠ?- ${weekStart.getMonth() + 1}æœˆç¬¬${Math.ceil(weekStart.getDate() / 7)}å‘?${aiAnalysisSuccess ? '(ğŸ¤– AIåˆ†æ)' : '(ğŸ“Š ä¼ ç»Ÿåˆ†æ)'}`,
                generateTime: currentDate.toLocaleString(),
                marketOverview: {
                    summary: marketSummary,
                    majorNews: extractMajorNews(marketInfo)
                },
                stockAnalysis: stockAnalysis,
                recommendation: generateRecommendation(stockAnalysis),
                dataSource: dataSourceLabel,
                aiAnalysis: aiAnalysisSuccess
            };
        }
        
        // è§£æAIè‚¡ç¥¨åˆ†æç»“æœ (LangChainå¢å¼ºç‰?
        function parseAIStockAnalysis(aiResult) {
            const analysis = aiResult.analysis || '';
            
            // æå–å…³é”®ä¿¡æ¯ - é€‚é…LangChainå¢å¼ºç‰ˆæ ¼å¼?
            let score = 75; // é»˜è®¤åˆ†æ•°æ›´é«˜
            let suggestion = 'æŒæœ‰';
            let targetPrice = '';
            let riskWarning = '';
            let coreLogic = '';
            
            // è§£ææ–°ç‰ˆLangChain APIçš„è¾“å‡ºæ ¼å¼?
            const operationMatch = analysis.match(/\*\*æ“ä½œå»ºè®®\*\*[ï¼?]\s*([ä¹°å…¥|æŒæœ‰|å‡ä»“|å–å‡º|åŠ ä»“])/);
            if (operationMatch) {
                suggestion = operationMatch[1];
                // æ ¹æ®å»ºè®®è°ƒæ•´è¯„åˆ†
                if (suggestion === 'ä¹°å…¥') score = 85;
                else if (suggestion === 'æŒæœ‰') score = 70;
                else if (suggestion === 'å‡ä»“') score = 45;
            }
            
            const targetPriceMatch = analysis.match(/\*\*ç›®æ ‡ä»·æ ¼\*\*[ï¼?]\s*Â¥([\d.]+)/);
            if (targetPriceMatch) targetPrice = `Â¥${targetPriceMatch[1]}`;
            
            const confidenceMatch = analysis.match(/\*\*ä¿¡å¿ƒåº¦\*\*[ï¼?]\s*([^(\n]+)/);
            if (confidenceMatch) coreLogic = confidenceMatch[1].trim();
            
            const positionMatch = analysis.match(/\*\*å»ºè®®ä»“ä½\*\*[ï¼?]\s*([^(]+)/);
            let positionAdvice = '';
            if (positionMatch) positionAdvice = positionMatch[1].trim();
            
            const riskMatch = analysis.match(/\*\*ä¸»è¦é£é™©\*\*[ï¼?]\s*([^\n]+)/);
            if (riskMatch) riskWarning = riskMatch[1].trim();
            
            // æå–æ ¸å¿ƒåˆ†æé€»è¾‘
            const businessMatch = analysis.match(/\*\*è¡Œä¸šåœ°ä½\*\*[ï¼?]\s*([^\n]+)/);
            if (businessMatch && !coreLogic) coreLogic = businessMatch[1].trim().substring(0, 50) + '...';
            
            // æ ¹æ®è¯„åˆ†ç¡®å®šå½±å“ç±»å‹
            let impact = 'neutral';
            if (score >= 75) impact = 'positive';
            else if (score <= 55) impact = 'negative';
            
            return {
                symbol: aiResult.symbol,
                name: aiResult.name || aiResult.symbol,
                summary: `${aiResult.name || aiResult.symbol} AIç»¼åˆè¯„åˆ†: ${score}/100åˆ†ã€?{suggestion}`,
                impact: impact,
                impactText: `â¡ï¸ å»ºè®®${suggestion}ï¼Œç›®æ ‡ä»·æ ?{targetPrice || 'å¾…å®š'}`,
                aiAnalysis: {
                    fullAnalysis: analysis,
                    score: score,
                    suggestion: suggestion,
                    targetPrice: targetPrice,
                    positionAdvice: positionAdvice,
                    riskWarning: riskWarning,
                    coreLogic: coreLogic
                },
                price: aiResult.technical_data || aiResult.langchain_info
            };
        }
        
        // è·å–è‚¡ç¥¨æ‰€å±æ¿å?
        function getStockSector(symbol) {
            const sectorMap = {
                '000001': 'é“¶è¡Œ',
                '600030': 'åˆ¸å•†', 
                '600519': 'ç™½é…’',
                '000858': 'ç™½é…’',
                '300750': 'æ–°èƒ½æº?,
                '002594': 'æ–°èƒ½æºæ±½è½?,
                '600362': 'æœ‰è‰²é‡‘å±',
                '601899': 'æœ‰è‰²é‡‘å±'
            };
            return sectorMap[symbol] || 'ç»¼åˆ';
        }

        // è¾…åŠ©å‡½æ•°
        function getCurrentDate() {
            return new Date().toISOString().split('T')[0];
        }

        function getWeekStartDate() {
            const now = new Date();
            const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            return weekStart.toISOString().split('T')[0];
        }

        function getStockName(symbol) {
            const stockMap = {
                '000001': 'å¹³å®‰é“¶è¡Œ', '600519': 'è´µå·èŒ…å°', '000858': 'äº”ç²®æ¶?,
                '300750': 'å®å¾·æ—¶ä»£', '002594': 'æ¯”äºšè¿?, '600036': 'æ‹›å•†é“¶è¡Œ',
                '600362': 'æ±Ÿè¥¿é“œä¸š', '601899': 'ç´«é‡‘çŸ¿ä¸š', '600030': 'ä¸­ä¿¡è¯åˆ¸',
                '601166': 'å…´ä¸šé“¶è¡Œ', '000002': 'ä¸‡ç§‘A', '601398': 'å·¥å•†é“¶è¡Œ',
                '601939': 'å»ºè®¾é“¶è¡Œ', '601288': 'å†œä¸šé“¶è¡Œ', '600000': 'æµ¦å‘é“¶è¡Œ',
                '002142': 'å®æ³¢é“¶è¡Œ', '600015': 'åå¤é“¶è¡Œ', '601318': 'ä¸­å›½å¹³å®‰',
                '601601': 'ä¸­å›½å¤ªä¿', '601319': 'ä¸­å›½äººä¿', '000568': 'æ³¸å·è€çª–',
                '000596': 'å¤äº•è´¡é…’', '002304': 'æ´‹æ²³è‚¡ä»½', '000799': 'é…’é¬¼é…?,
                '603589': 'å£å­çª?, '000860': 'é¡ºé‘«å†œä¸š', '002415': 'æµ·å¤©å‘³ä¸š',
                '600887': 'ä¼Šåˆ©è‚¡ä»½', '002466': 'å¤©é½é”‚ä¸š', '002460': 'èµ£é”‹é”‚ä¸š',
                '300014': 'äº¿çº¬é”‚èƒ½', '002812': 'æ©æ·è‚¡ä»½', '300207': 'æ¬£æ—ºè¾?,
                '300438': 'é¹è¾‰èƒ½æº', '600884': 'æ‰æ‰è‚¡ä»½', '000063': 'ä¸­å…´é€šè®¯',
                '002415': 'æµ·åº·å¨è§†', '002230': 'ç§‘å¤§è®¯é£', '300496': 'ä¸­ç§‘åˆ›è¾¾',
                '000977': 'æµªæ½®ä¿¡æ¯', '002837': 'è‹±ç»´å…?
            };
            return stockMap[symbol] || symbol;
        }

        function generateAnalysisSummary(symbol, change) {
            // åŸºäºè‚¡ç¥¨ç‰¹æ€§å’Œæ¶¨è·Œå¹…çš„ä¸“ä¸šåˆ†æ
            const stockProfiles = {
                '600036': 'é›¶å”®é“¶è¡Œé¾™å¤´ï¼Œè´¢å¯Œç®¡ç†ä¼˜åŠ¿æ˜æ˜?,
                '601318': 'ç»¼åˆé‡‘èå¹³å°ï¼Œä¿é™?é“¶è¡ŒåŒè½®é©±åŠ¨',
                '002837': 'AIç®—åŠ›åˆ¶å†·è®¾å¤‡é¾™å¤´ï¼Œå—ç›Šæ•°æ®ä¸­å¿ƒå»ºè®?,
                '000977': 'æœåŠ¡å™¨å‚å•†ï¼ŒAIç®—åŠ›éœ€æ±‚å—ç›Šæ ‡çš?,
                '600030': 'å¤´éƒ¨åˆ¸å•†ï¼Œå—ç›Šèµ„æœ¬å¸‚åœºæ”¹é?
            };
            
            const profile = stockProfiles[symbol] || 'ä¼˜è´¨æ ‡çš„';
            
            if (change > 2) return `${profile}ï¼ŒæŠ€æœ¯é¢çªç ´ï¼Œå»ºè®®å…³æ³¨ä¹°å…¥æœºä¼š`;
            if (change > 0.5) return `${profile}ï¼Œè¡¨ç°ç¨³å¥ï¼Œå¯è€ƒè™‘é€‚å½“é…ç½®`;
            if (change < -2) return `${profile}ï¼ŒçŸ­æœŸå›è°ƒï¼Œé€¢ä½å¸ƒå±€è‰¯æœº`;
            if (change < -0.5) return `${profile}ï¼Œè°ƒæ•´ä¸­å¯»æ‰¾æ”¯æ’‘ï¼Œè€å¿ƒç­‰å¾…`;
            return `${profile}ï¼Œéœ‡è¡æ•´ç†ï¼Œå…³æ³¨åç»­æ–¹å‘é€‰æ‹©`;
        }

        function generateImpactText(change) {
            if (change > 3) return 'å¼ºåŠ¿çªç ´ï¼Œå»ºè®®é€‚å½“åŠ ä»“ï¼Œæ­¢æŸè®¾ç½®åœ¨æ¶¨å¹…5%å¤?;
            if (change > 1) return 'è¡¨ç°ç§¯æï¼Œå¯è€ƒè™‘åˆ†æ‰¹ä¹°å…¥ï¼Œæ§åˆ¶å•ç¬”ä»“ä½?%ä»¥å†…';
            if (change > 0) return 'éœ‡è¡ä¸Šè¡Œï¼Œè€å¿ƒæŒæœ‰ï¼Œå…³æ³¨é‡èƒ½æ”¾å¤§æƒ…å†?;
            if (change > -2) return 'å°å¹…è°ƒæ•´ï¼Œå¯»æ‰¾æ”¯æ’‘ä½ä¹°å…¥æœºä¼š';
            if (change > -4) return 'æŠ€æœ¯æ€§å›è°ƒï¼Œé€¢ä½å¸ƒå±€è‰¯æœºï¼Œåˆ†æ‰¹å»ºä»?;
            return 'æ·±åº¦è°ƒæ•´ä¸­ï¼Œç­‰å¾…ä¼ç¨³ä¿¡å·ï¼Œä¸¥æ ¼æ§åˆ¶é£é™?;
        }

        function extractMajorNews(marketInfo) {
            const realNews = [];
            
            // æ£€æŸ¥æ˜¯å¦æœ‰çœŸå®çš„å¸‚åœºåˆ†ææ•°æ?
            if (marketInfo.general && marketInfo.general.length > 0) {
                for (const item of marketInfo.general) {
                    if (item.source === 'deepseek_ai' && item.result) {
                        // ä»LangChainå¸‚åœºåˆ†æä¸­æå–å…³é”®ä¿¡æ?
                        const analysis = item.result;
                        
                        // æå–é‡ç‚¹æœºä¼šä¿¡æ¯
                        if (analysis.includes('ä¹°å…¥æœºä¼š')) {
                            const buyMatch = analysis.match(/\*\*ä¹°å…¥æœºä¼š\*\*[ï¼?]\s*([^\n*]+)/);
                            if (buyMatch) {
                                realNews.push({
                                    title: "å¸‚åœºä¹°å…¥æœºä¼šæ˜¾ç°",
                                    impact: "positive", 
                                    summary: buyMatch[1].trim()
                                });
                            }
                        }
                        
                        // æå–é£é™©æç¤º
                        if (analysis.includes('ä¸»è¦é£é™©')) {
                            const riskMatch = analysis.match(/\*\*ä¸»è¦é£é™©\*\*[ï¼?]\s*([^\n*]+)/);
                            if (riskMatch) {
                                realNews.push({
                                    title: "å¸‚åœºé£é™©æç¤º",
                                    impact: "negative",
                                    summary: riskMatch[1].trim()
                                });
                            }
                        }
                        
                        // æå–æ“ä½œå»ºè®®
                        if (analysis.includes('æ“ä½œå»ºè®®')) {
                            const adviceMatch = analysis.match(/\*\*å»ºè®®ä»“ä½\*\*[ï¼?]\s*([^\n*]+)/);
                            if (adviceMatch) {
                                realNews.push({
                                    title: "æŠ•èµ„ä»“ä½å»ºè®®",
                                    impact: "neutral",
                                    summary: `å»ºè®®ä»“ä½${adviceMatch[1].trim()}`
                                });
                            }
                        }
                        
                        break; // æ‰¾åˆ°DeepSeekåˆ†æåå°±åœæ­¢
                    }
                }
            }
            
            // å¦‚æœæ²¡æœ‰è·å–åˆ°çœŸå®æ–°é—»ï¼Œè¿”å›é»˜è®¤æ–°é—»
            if (realNews.length === 0) {
                console.warn('âš ï¸ æœªè·å–åˆ°çœŸå®å¸‚åœºåˆ†æï¼Œä½¿ç”¨é»˜è®¤æ–°é—?);
                return [
                    { title: "å¸‚åœºæµåŠ¨æ€§ä¿æŒåˆç†å……è£?, impact: "positive", summary: "æœ‰åˆ©äºä¼°å€¼ä¿®å¤? },
                    { title: "ç»æµæ•°æ®è¶…é¢„æœ?, impact: "positive", summary: "åŸºæœ¬é¢æ”¯æ’‘å¢å¼? },
                    { title: "åœ°ç¼˜é£é™©éœ€è¦å…³æ³?, impact: "neutral", summary: "ä¿æŒé€‚åº¦è°¨æ…" }
                ];
            }
            
            console.log('âœ?ä½¿ç”¨çœŸå®å¸‚åœºåˆ†æç”Ÿæˆæ–°é—»:', realNews.length, 'æ?);
            return realNews;
        }

        function generateRecommendation(stockAnalysis) {
            const positiveCount = stockAnalysis.filter(s => s.impact === 'positive').length;
            const negativeCount = stockAnalysis.filter(s => s.impact === 'negative').length;
            
            if (positiveCount > negativeCount) {
                return "æ•´ä½“å¸‚åœºæƒ…ç»ªåå‘ç§¯æï¼Œå»ºè®®é€‚åº¦å¢åŠ ä¼˜è´¨ä¸ªè‚¡é…ç½®ï¼Œä½†éœ€æ³¨æ„æ§åˆ¶é£é™©æ•å£ã€?;
            } else if (negativeCount > positiveCount) {
                return "å¸‚åœºå­˜åœ¨ä¸€å®šå‹åŠ›ï¼Œå»ºè®®é™ä½ä»“ä½ï¼Œç­‰å¾…æ›´å¥½çš„å…¥åœºæ—¶æœºã€?;
            } else {
                return "å¸‚åœºå¤„äºå¹³è¡¡çŠ¶æ€ï¼Œå»ºè®®ç»´æŒç°æœ‰é…ç½®ï¼Œæ‹©æœºè°ƒæ•´ç»“æ„ã€?;
            }
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿç®€æŠ¥æ•°æ?
        async function generateMockReport(subscriptions) {
            const currentDate = new Date();
            const weekStart = new Date(currentDate.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            // æ¨¡æ‹Ÿå¸‚åœºä¿¡æ¯æ”¶é›†
            const marketNews = [
                {
                    title: "å¤®è¡Œè´§å¸æ”¿ç­–è¾¹é™…å®½æ¾",
                    impact: "positive",
                    summary: "å¤®è¡Œé‡Šæ”¾æµåŠ¨æ€§ï¼Œæœ‰åˆ©äºä¼°å€¼ä¿®å¤?
                },
                {
                    title: "ç¾è”å‚¨åŠ æ¯é¢„æœŸé™æ¸?,
                    impact: "positive", 
                    summary: "å¤–éƒ¨ç¯å¢ƒæ”¹å–„ï¼Œæœ‰åˆ©äºé£é™©åå¥½æå‡"
                },
                {
                    title: "åœ°ç¼˜æ”¿æ²»é£é™©ä¸Šå‡",
                    impact: "negative",
                    summary: "é¿é™©æƒ…ç»ªå‡æ¸©ï¼Œå¯èƒ½å½±å“é£é™©èµ„äº?
                }
            ];

            // ä¸ºæ¯åªè‚¡ç¥¨ç”Ÿæˆåˆ†æ?
            const stockAnalysis = subscriptions.slice(0, 8).map(stock => {
                const impacts = ['positive', 'negative', 'neutral'];
                const randomImpact = impacts[Math.floor(Math.random() * impacts.length)];
                
                const analysisTemplates = {
                    positive: [
                        `${stock.name}æœ¬å‘¨è¡¨ç°å¼ºåŠ¿ï¼ŒåŸºæœ¬é¢å‘å¥½è¶‹åŠ¿æ˜ç¡®`,
                        `${stock.name}è·å¾—æœºæ„é›†ä¸­è°ƒç ”ï¼Œä¸šç»©é¢„æœŸä¸Šè°ƒ`,
                        `${stock.name}è¡Œä¸šæ™¯æ°”åº¦æå‡ï¼Œå…¬å¸å—ç›Šæ˜æ˜¾`
                    ],
                    negative: [
                        `${stock.name}é¢ä¸´è¡Œä¸šå‘¨æœŸæ€§è°ƒæ•´å‹åŠ›`,
                        `${stock.name}çŸ­æœŸä¸šç»©å¢é•¿æ”¾ç¼“ï¼Œéœ€å…³æ³¨ç»è¥æ‹ç‚¹`,
                        `${stock.name}å—å®è§‚ç¯å¢ƒå½±å“ï¼Œä¼°å€¼æ‰¿å‹`
                    ],
                    neutral: [
                        `${stock.name}æ•´ä½“è¡¨ç°å¹³ç¨³ï¼Œç­‰å¾…å‚¬åŒ–å‰‚å‡ºç°`,
                        `${stock.name}åŸºæœ¬é¢ç¨³å¥ï¼Œä½†ç¼ºä¹æ˜æ˜¾ä¸Šæ¶¨é©±åŠ¨`,
                        `${stock.name}å¤„äºéœ‡è¡æ•´ç†é˜¶æ®µï¼Œå¯é€¢ä½å…³æ³¨`
                    ]
                };

                const impactTemplates = {
                    positive: [
                        "é¢„æœŸçŸ­æœŸå†…æœ‰æœ›è¿æ¥ä¼°å€¼ä¿®å¤æœºä¼?,
                        "å»ºè®®é€‚åº¦å¢åŠ é…ç½®æ¯”ä¾‹",
                        "ä¸­é•¿æœŸæŠ•èµ„ä»·å€¼å‡¸æ˜¾ï¼Œå»ºè®®æŒç»­å…³æ³¨"
                    ],
                    negative: [
                        "å»ºè®®çŸ­æœŸå†…è°¨æ…æ“ä½œï¼Œç­‰å¾…æ›´å¥½å…¥åœºæ—¶æœº",
                        "éœ€å¯†åˆ‡å…³æ³¨åŸºæœ¬é¢å˜åŒ–ï¼Œæ§åˆ¶ä»“ä½é£é™©",
                        "å»ºè®®é™ä½é…ç½®æ¯”ä¾‹ï¼Œè§‚æœ›ä¸ºä¸?
                    ],
                    neutral: [
                        "ç»´æŒç°æœ‰ä»“ä½ï¼Œç­‰å¾…æ˜ç¡®æ–¹å‘ä¿¡å?,
                        "å¯é€‚å½“é€¢ä½å¸ƒå±€ï¼Œä½†éœ€æ§åˆ¶èŠ‚å¥",
                        "å…³æ³¨æ”¿ç­–é¢å’ŒåŸºæœ¬é¢å˜åŒ–ï¼Œæ‹©æœºæ“ä½œ"
                    ]
                };

                return {
                    symbol: stock.symbol,
                    name: stock.name,
                    summary: analysisTemplates[randomImpact][Math.floor(Math.random() * 3)],
                    impact: randomImpact,
                    impactText: impactTemplates[randomImpact][Math.floor(Math.random() * 3)]
                };
            });

            return {
                title: `MarketBrew æ™ºèƒ½ç®€æŠ?- ${weekStart.getMonth() + 1}æœˆç¬¬${Math.ceil(weekStart.getDate() / 7)}å‘¨`,
                generateTime: currentDate.toLocaleString(),
                marketOverview: {
                    summary: "æœ¬å‘¨Aè‚¡å¸‚åœºéœ‡è¡ä¸Šè¡Œï¼Œç§‘æŠ€è‚¡è¡¨ç°ç›¸å¯¹å¼ºåŠ¿ã€‚å¤®è¡Œè´§å¸æ”¿ç­–è¾¹é™…å®½æ¾ï¼Œå¸‚åœºæµåŠ¨æ€§å……è£•ï¼ŒæŠ•èµ„è€…é£é™©åå¥½æœ‰æ‰€æå‡ã€?,
                    majorNews: marketNews
                },
                stockAnalysis: stockAnalysis,
                recommendation: "æ•´ä½“è€Œè¨€ï¼Œå½“å‰å¸‚åœºå¤„äºåº•éƒ¨åŒºåŸŸï¼Œå»ºè®®æŠ•èµ„è€…ä¿æŒé€‚åº¦ä¹è§‚ï¼Œé‡ç‚¹å…³æ³¨åŸºæœ¬é¢ä¼˜ç§€ã€ä¼°å€¼åˆç†çš„ä¼˜è´¨ä¸ªè‚¡ã€‚åœ¨ä»“ä½ç®¡ç†ä¸Šï¼Œå»ºè®®é‡‡å–åˆ†æ‰¹å¸ƒå±€ç­–ç•¥ï¼Œæ§åˆ¶å¥½é£é™©æ•å£ã€?
            };
        }

        // æ˜¾ç¤ºç®€æŠ?
        function displayReport(reportData) {
            const reportContent = document.getElementById('reportContent');
            
            const impactIcons = {
                positive: 'ğŸ“ˆ',
                negative: 'ğŸ“‰', 
                neutral: 'â¡ï¸'
            };

            const impactColors = {
                positive: 'positive',
                negative: 'negative',
                neutral: 'neutral'
            };

            reportContent.innerHTML = `
                <div class="report-generated">
                    <div class="report-title">
                        ${reportData.title}
                    </div>
                    
                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 24px;">
                        ç”Ÿæˆæ—¶é—´: ${reportData.generateTime}
                    </div>

                    <div class="report-section-title">
                        ğŸŒ å¸‚åœºæ¦‚å†µ
                    </div>
                    <div class="market-analysis-container" style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; white-space: pre-line; line-height: 1.8; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        ${reportData.marketOverview.summary
                            .replace(/## ([^\n]+)/g, '<div style="color: #1f2937; font-weight: bold; font-size: 18px; margin: 24px 0 16px 0; border-left: 4px solid #3b82f6; padding-left: 16px; background: #f8fafc; padding: 12px 16px; border-radius: 6px;">$1</div>')
                            .replace(/\*\*([^*]+)\*\*/g, '<strong style="color: #1f2937; background: #fef3c7; padding: 2px 6px; border-radius: 4px;">$1</strong>')
                            .replace(/(\d{4}\.?\d*ç‚?/g, '<span style="color: #dc2626; font-weight: bold;">$1</span>')
                            .replace(/(\d+%)/g, '<span style="color: #059669; font-weight: bold;">$1</span>')
                        }
                    </div>

                    <div class="report-section-title">
                        ğŸ“Š é‡è¦èµ„è®¯
                    </div>
                    ${reportData.marketOverview.majorNews.map(news => `
                        <div class="report-item">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span>${impactIcons[news.impact]}</span>
                                <strong>${news.title}</strong>
                            </div>
                            <div class="report-impact ${impactColors[news.impact]}">
                                ${news.summary}
                            </div>
                        </div>
                    `).join('')}

                    <div class="report-section-title">
                        ğŸ¯ ä¸ªè‚¡åˆ†æ
                    </div>
                    ${reportData.stockAnalysis.map(stock => `
                        <div class="report-item">
                            <div class="report-stock-name">
                                ${stock.symbol} ${stock.name}
                            </div>
                            ${stock.aiAnalysis && stock.aiAnalysis.fullAnalysis ? 
                                `<div class="report-full-analysis" style="background: #f8fafc; border-radius: 8px; padding: 16px; margin: 12px 0; white-space: pre-line; line-height: 1.6; color: #374151;">
                                    ${stock.aiAnalysis.fullAnalysis.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>').replace(/## ([^\n]+)/g, '<h4 style="color: #1f2937; margin: 16px 0 8px 0; font-size: 14px;">$1</h4>')}
                                </div>` : 
                                `<div class="report-summary">
                                    ${stock.summary}
                                </div>
                                <div class="report-impact ${impactColors[stock.impact]}">
                                    ${impactIcons[stock.impact]} ${stock.impactText}
                                </div>`
                            }
                        </div>
                    `).join('')}

                    <div class="report-section-title">
                        ğŸ’¡ æŠ•èµ„å»ºè®®
                    </div>
                    <div style="background: white; border-radius: 8px; padding: 16px; border-left: 4px solid #10b981;">
                        ${reportData.recommendation}
                    </div>
                </div>
            `;
        }

        
        // æ·»åŠ ç¤ºä¾‹è‚¡ç¥¨
        function restoreSubscriptions() {
            const exampleStocks = [
                {symbol: '000001', name: 'å¹³å®‰é“¶è¡Œ'},
                {symbol: '600519', name: 'è´µå·èŒ…å°'},
                {symbol: '000858', name: 'äº”ç²®æ¶?},
                {symbol: '300750', name: 'å®å¾·æ—¶ä»£'},
                {symbol: '002594', name: 'æ¯”äºšè¿?},
                {symbol: '600036', name: 'æ‹›å•†é“¶è¡Œ'}
            ];
            
            const subscriptions = exampleStocks.map(stock => ({
                symbol: stock.symbol,
                name: stock.name,
                addedAt: new Date().toISOString()
            }));
            
            // ä½¿ç”¨æ–°çš„å­˜å‚¨æ–¹æ³•
            if (window.subscriptionManager) {
                window.subscriptionManager.saveToStorage('subscriptions', subscriptions);
                window.subscriptionManager.subscriptions = subscriptions;
                window.subscriptionManager.updateSubscriptionList();
                window.subscriptionManager.showNotification('ğŸ“‹ ç¤ºä¾‹è‚¡ç¥¨å·²æ·»åŠ?, 'å·²æ·»åŠ?åªçƒ­é—¨è‚¡ç¥¨ä¾›æ‚¨ä½“éªŒåˆ†æåŠŸèƒ?);
            } else {
                localStorage.setItem('marketbrew_subscriptions', JSON.stringify(subscriptions));
                location.reload();
            }
        }

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶éšè—å»ºè®®æ¡†
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.subscription-box')) {
                const quickSuggestions = document.getElementById('quickSuggestions');
                const navbarSuggestions = document.getElementById('navbarSuggestions');
                if (quickSuggestions) quickSuggestions.style.display = 'none';
                if (navbarSuggestions) navbarSuggestions.style.display = 'none';
            }
        });
        
        // é¡µé¢å¸è½½æ—¶å¤‡ä»½æ•°æ?
        window.addEventListener('beforeunload', () => {
            if (subscriptionManager && subscriptionManager.subscriptions.length > 0) {
                subscriptionManager.saveSubscriptions();
                console.log('ğŸ’¾ é¡µé¢å…³é—­å‰å·²å¤‡ä»½æ•°æ®');
            }
        });
        
        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶å¤‡ä»½æ•°æ®
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && subscriptionManager) {
                subscriptionManager.saveSubscriptions();
                console.log('ğŸ’¾ é¡µé¢éšè—æ—¶å·²å¤‡ä»½æ•°æ®');
            }
        });
        
        // æ›´æ–°åŠ¨æ€æ—¥æœŸæ˜¾ç¤?
        function updateDynamicDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const date = now.getDate();
            
            // è®¡ç®—æ˜¯ä»Šå¹´çš„ç¬¬å‡ å¤?
            const startOfYear = new Date(year, 0, 1);
            const dayOfYear = Math.ceil((now - startOfYear) / (1000 * 60 * 60 * 24)) + 1;
            
            // è·å–æ˜ŸæœŸ
            const weekdays = ['æ—?, 'ä¸€', 'äº?, 'ä¸?, 'å›?, 'äº?, 'å…?];
            const weekday = weekdays[now.getDay()];
            
            // åˆ¤æ–­å¸‚åœºçŠ¶æ€?
            const hour = now.getHours();
            const minute = now.getMinutes();
            const currentTime = hour * 100 + minute;
            
            let marketStatus = 'ä¼‘å¸‚';
            if (now.getDay() >= 1 && now.getDay() <= 5) { // å·¥ä½œæ—?
                if ((currentTime >= 930 && currentTime <= 1130) || 
                    (currentTime >= 1300 && currentTime <= 1500)) {
                    marketStatus = 'æ­£å¸¸äº¤æ˜“';
                } else if (currentTime >= 915 && currentTime < 930) {
                    marketStatus = 'é›†åˆç«ä»·';
                } else if (currentTime > 1500 && currentTime <= 1530) {
                    marketStatus = 'ç›˜åäº¤æ˜“';
                } else {
                    marketStatus = 'éäº¤æ˜“æ—¶é—?;
                }
            }
            
            // ç”Ÿæˆæ—¥æœŸå­—ç¬¦ä¸?
            const dateStr = `${year}å¹?{month}æœ?{date}æ—?å‘?{weekday} Â· ç¬?{dayOfYear}å¤?Â· ${marketStatus}`;
            
            const dateElement = document.getElementById('dynamicDate');
            if (dateElement) {
                dateElement.textContent = dateStr;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåˆå§‹åŒ?
        // EMT ÔñÊ±Çø¾ÛºÏ
        const TIMING_API = 'http://localhost:5001';
        async function fetchTimingOverview(index = '000300') {
            try {
                const res = await fetch(`${TIMING_API}/api/timing/overview?index=${index}`);
                const json = await res.json();
                if (!json.success) throw new Error(json.error || 'ÇëÇóÊ§°Ü');
                const data = json.data;
            // ¼ÓÔØÔñÊ±Çø²¢¶¨Ê±Ë¢ĞÂ\n\nconst ut = document.getElementById('timingUpdateTime');
                if (ut) ut.textContent = `¸üĞÂÓÚ ${data.update_time}`;
                const t = data.trend || {};
                const trendMain = document.getElementById('tzTrendMain');
                const trendSub = document.getElementById('tzTrendSub');
                if (trendMain) {
                    trendMain.textContent = t.is_uptrend ? 'Ç÷ÊÆÏòÉÏ£¨Õ¾ÎÈMA20/30£©' : 'Ç÷ÊÆÎ´È·Á¢';
                    trendMain.style.color = t.is_uptrend ? '#16a34a' : '#dc2626';
                }
                if (trendSub) {
                    const parts = [];
                    if (t.latest_close) parts.push(`ÊÕ ${t.latest_close}`);
                    if (t.ma20) parts.push(`MA20 ${t.ma20}`);
                    if (t.ma30) parts.push(`MA30 ${t.ma30}`);
                    parts.push(`Á¬ÉÏÌìÊı ${t.stand_above_days || 0}`);
                    trendSub.textContent = parts.join(' ¡¤ ');
                }
                const c = data.capital || {};
                const capMain = document.getElementById('tzCapitalMain');
                const capSub = document.getElementById('tzCapitalSub');
                if (capMain) {
                    const good = (c.north_3d || 0) > 0 && (c.etf_7d || 0) > 0 && (c.main_1d || 0) > 0;
                    capMain.textContent = good ? '×Ê½ğ¾»Á÷Èë' : '×Ê½ğ·Ö»¯/Á÷³ö';
                    capMain.style.color = good ? '#16a34a' : '#dc2626';
                }
                if (capSub) {
                    capSub.textContent = `±±Ïò3ÈÕ ${c.north_3d || 0} ÒÚ ¡¤ ETF7ÈÕ ${c.etf_7d || 0} ÒÚ ¡¤ Ö÷Á¦1ÈÕ ${c.main_1d || 0} ÒÚ ¡¤ ÆÀ·Ö ${c.score || 0}`;
                }
                const e = data.emotion || {};
                const emoMain = document.getElementById('tzEmotionMain');
                const emoSub = document.getElementById('tzEmotionSub');
                if (emoMain) {
                    emoMain.textContent = e.phase || 'Î´Öª';
                    const phase = e.phase || '';
                    emoMain.style.color = (phase === '¼ÓËÙ' || phase === 'ĞŞ¸´') ? '#16a34a' : (phase === '±ùµã' ? '#dc2626' : '#374151');
                }
                if (emoSub) {
                    emoSub.textContent = (e.basis || []).join(' ¡¤ ');
                }
            } catch (err) {
                console.error('ÔñÊ±×ÜÀÀ»ñÈ¡Ê§°Ü', err);
                const ut = document.getElementById('timingUpdateTime');
                if (ut) ut.textContent = 'Êı¾İ»ñÈ¡Ê§°Ü£¬Çë¼ì²é 5001 ·şÎñ';
            }
        }
        window.addEventListener('load', () => {
            console.log('ğŸ‰ MarketBrew AIåˆ†æç³»ç»ŸåŠ è½½å®Œæˆ');
            console.log('ğŸ’¾ æ•°æ®æ°¸ä¹…ä¿å­˜ï¼Œå…³é—­æµè§ˆå™¨ä¸ä¼šä¸¢å¤±');
            console.log('ğŸ¤– DeepSeek AIåˆ†æå·²é›†æˆ?);
            
            // æ›´æ–°åŠ¨æ€æ—¥æœ?
            updateDynamicDate();
            
            // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ—¥æœŸå’Œå¸‚åœºçŠ¶æ€?
            setInterval(updateDynamicDate, 60000);
            fetchTimingOverview('000300');
            setInterval(() => fetchTimingOverview('000300'), 300000);
        });
            async function checkTimingHealth() {
            try {
                const res = await fetch(${TIMING_API}/health);
                if (!res.ok) throw new Error('health fail');
                const data = await res.json();
                const el = document.getElementById('tzApiStatus');
                if (el) { el.textContent = 'OK'; el.style.color = '#16a34a'; }
            } catch (e) {
                const el = document.getElementById('tzApiStatus');
                if (el) { el.textContent = 'FAIL'; el.style.color = '#dc2626'; }
            }
        }
        window.addEventListener('load', () => { try { checkTimingHealth(); } catch(e){} });

</html>
