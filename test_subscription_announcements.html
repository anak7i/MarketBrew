<!DOCTYPE html>
<html>
<head>
    <title>æµ‹è¯•è®¢é˜…å…¬å‘ŠåŠŸèƒ½</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            line-height: 1.6; 
        }
        .section { 
            margin-bottom: 30px; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover { background: #0056b3; }
        #results { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 4px; 
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ“Š è®¢é˜…å…¬å‘ŠåŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="section">
        <h2>1. æ¨¡æ‹Ÿè®¢é˜…ç®¡ç†</h2>
        <button class="button" onclick="addTestSubscription('000001', 'å¹³å®‰é“¶è¡Œ')">æ·»åŠ  000001 å¹³å®‰é“¶è¡Œ</button>
        <button class="button" onclick="addTestSubscription('600519', 'è´µå·èŒ…å°')">æ·»åŠ  600519 è´µå·èŒ…å°</button>
        <button class="button" onclick="clearSubscriptions()">æ¸…ç©ºè®¢é˜…</button>
        <div id="subscriptionList"></div>
    </div>
    
    <div class="section">
        <h2>2. å…¬å‘ŠåŠ è½½æµ‹è¯•</h2>
        <button class="button" onclick="testAnnouncementLoading()">æµ‹è¯•å…¬å‘ŠåŠ è½½</button>
        <div id="results"></div>
    </div>
    
    <script>
        // æ¨¡æ‹Ÿè®¢é˜…ç®¡ç†å™¨
        const mockSubscriptionManager = {
            subscriptions: [],
            addSubscription: function(symbol, name) {
                this.subscriptions.push({ symbol, name });
                this.updateDisplay();
            },
            removeSubscription: function(symbol) {
                this.subscriptions = this.subscriptions.filter(sub => sub.symbol !== symbol);
                this.updateDisplay();
            },
            updateDisplay: function() {
                const container = document.getElementById('subscriptionList');
                container.innerHTML = '<h3>å½“å‰è®¢é˜…:</h3>' + 
                    this.subscriptions.map(sub => 
                        `<div>${sub.symbol} - ${sub.name} <button class="button" onclick="mockSubscriptionManager.removeSubscription('${sub.symbol}')">ç§»é™¤</button></div>`
                    ).join('') + 
                    (this.subscriptions.length === 0 ? '<p>æš‚æ— è®¢é˜…</p>' : '');
            }
        };
        
        // å…¨å±€å¼•ç”¨ï¼Œæ¨¡æ‹ŸçœŸå®çš„subscriptionManager
        window.subscriptionManager = mockSubscriptionManager;
        
        function addTestSubscription(symbol, name) {
            mockSubscriptionManager.addSubscription(symbol, name);
        }
        
        function clearSubscriptions() {
            mockSubscriptionManager.subscriptions = [];
            mockSubscriptionManager.updateDisplay();
        }
        
        // å¤åˆ¶loadAnnouncementså‡½æ•°é€»è¾‘
        async function testAnnouncementLoading() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = 'â³ æ­£åœ¨åŠ è½½å…¬å‘Š...';
            
            try {
                const newsApiBase = 'http://localhost:5007';
                // è·å–ç”¨æˆ·è®¢é˜…çš„è‚¡ç¥¨å…¬å‘Š
                const subscriptions = subscriptionManager ? subscriptionManager.subscriptions : [];
                
                if (subscriptions.length === 0) {
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; color: #718096; padding: 30px; font-size: 14px;">
                            ğŸ“‹ æš‚æ— è®¢é˜…è‚¡ç¥¨<br>
                            <small style="font-size: 12px;">è¯·å…ˆæ·»åŠ è®¢é˜…è‚¡ç¥¨ä»¥æŸ¥çœ‹ç›¸å…³å…¬å‘Š</small>
                        </div>
                    `;
                    return;
                }
                
                resultsDiv.innerHTML = `â³ æ­£åœ¨è·å– ${subscriptions.length} ä¸ªè‚¡ç¥¨çš„å…¬å‘Š...`;
                
                const symbols = subscriptions.slice(0, 8).map(sub => sub.symbol); // é™åˆ¶æœ€å¤š8ä¸ªè‚¡ç¥¨é¿å…è¯·æ±‚è¿‡å¤š
                const promises = symbols.map(symbol => 
                    fetch(`${newsApiBase}/api/announcements/${symbol}?days=7&limit=2`)
                        .then(res => res.json())
                        .catch(() => ({ success: false, error: 'APIè¯·æ±‚å¤±è´¥' }))
                );

                const results = await Promise.all(promises);
                let allAnnouncements = [];

                results.forEach((data, index) => {
                    if (data.success && data.announcements) {
                        const symbolAnnouncements = data.announcements.map(ann => ({
                            ...ann,
                            symbol: symbols[index]
                        }));
                        allAnnouncements.push(...symbolAnnouncements);
                    }
                });

                // æŒ‰é‡è¦æ€§å’Œæ—¶é—´æ’åº
                allAnnouncements.sort((a, b) => {
                    if (a.importance_level !== b.importance_level) {
                        return (b.importance_level || 0) - (a.importance_level || 0);
                    }
                    return new Date(b.publish_date) - new Date(a.publish_date);
                });

                if (allAnnouncements.length > 0) {
                    const html = `
                        <h3>ğŸ“‹ è·å–åˆ° ${allAnnouncements.length} æ¡å…¬å‘Š</h3>
                        ${allAnnouncements.map(ann => {
                            const formatTime = (dateStr) => {
                                const date = new Date(dateStr);
                                return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                            };
                            
                            return `
                                <div style="border: 1px solid #eee; padding: 15px; margin: 10px 0; border-radius: 4px; background: white;">
                                    <div style="font-weight: bold; color: #333;">[${ann.symbol}] ${ann.title}</div>
                                    <div style="font-size: 12px; color: #666; margin: 5px 0;">
                                        ${ann.announcement_type || 'ä¼ä¸šå…¬å‘Š'} â€¢ ${formatTime(ann.publish_date)}
                                        ${ann.source_url ? `â€¢ <a href="${ann.source_url}" target="_blank" style="color: #667eea;">ğŸ”— åŸæ–‡</a>` : ''}
                                    </div>
                                    ${ann.deepseek_analysis ? `
                                        <div style="margin-top: 8px; padding: 8px; background: #f8fafc; border-radius: 4px; font-size: 12px; color: #4a5568;">
                                            <span style="color: #667eea; font-weight: 500;">ğŸ¤– AIè§£è¯»ï¼š</span>
                                            ${ann.deepseek_analysis.analysis}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    `;
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; color: #718096; padding: 30px;">
                            ğŸ“‹ æš‚æ— å…¬å‘Šæ•°æ®<br>
                            <small>å¯èƒ½æ˜¯APIæœåŠ¡æœªå“åº”</small>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('å…¬å‘ŠåŠ è½½å¤±è´¥:', error);
                resultsDiv.innerHTML = `
                    <div style="color: red; padding: 20px;">
                        âŒ å…¬å‘ŠåŠ è½½å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }
        
        // åˆå§‹åŒ–æ˜¾ç¤º
        mockSubscriptionManager.updateDisplay();
    </script>
</body>
</html>