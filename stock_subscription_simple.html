<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketBrew - Aè‚¡æ™ºèƒ½è®¢é˜…</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .navbar {
            background: white;
            padding: 16px 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 20px;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .add-form {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .add-input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .add-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .add-btn:hover {
            background: #3367d6;
        }

        .subscription-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .subscription-item {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #4285f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stock-info h4 {
            margin-bottom: 4px;
            color: #333;
        }

        .stock-info p {
            color: #666;
            font-size: 14px;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px;
        }

        .storage-info {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .storage-info h4 {
            color: #1976d2;
            margin-bottom: 8px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 4px;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-title">ğŸ“ˆ MarketBrew - Aè‚¡è®¢é˜…ç®¡ç†</div>
        <div>å…³é—­æµè§ˆå™¨ä¸ä¸¢å¤±ç‰ˆæœ¬</div>
    </div>

    <div class="container">
        <div class="section">
            <div class="section-title">ğŸ’¾ å­˜å‚¨çŠ¶æ€</div>
            <div class="storage-info">
                <h4>æ°¸ä¹…å­˜å‚¨ä¿è¯</h4>
                <p>âœ… æ‚¨çš„è®¢é˜…æ•°æ®ä½¿ç”¨ localStorage æ°¸ä¹…ä¿å­˜</p>
                <p>âœ… å…³é—­æµè§ˆå™¨ã€é‡å¯ç”µè„‘éƒ½ä¸ä¼šä¸¢å¤±</p>
                <p>âœ… æ¯æ¬¡æ“ä½œéƒ½ä¼šè‡ªåŠ¨ä¿å­˜</p>
            </div>
            <button class="btn btn-info" onclick="showStorageInfo()">ğŸ“Š æŸ¥çœ‹å­˜å‚¨è¯¦æƒ…</button>
            <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
            <button class="btn btn-success" onclick="exportData()">ğŸ’¾ å¯¼å‡ºå¤‡ä»½</button>
            <button class="btn btn-success" onclick="importData()">ğŸ“‚ å¯¼å…¥å¤‡ä»½</button>
        </div>

        <div class="section">
            <div class="section-title">â• æ·»åŠ è‚¡ç¥¨è®¢é˜…</div>
            <div class="add-form">
                <input type="text" class="add-input" id="stockInput" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§° (å¦‚: 000001 æˆ– å¹³å®‰é“¶è¡Œ)" />
                <button class="add-btn" onclick="addStock()">æ·»åŠ è®¢é˜…</button>
            </div>
        </div>

        <div class="section">
            <div class="section-title">ğŸ“‹ æˆ‘çš„è®¢é˜…åˆ—è¡¨ (<span id="stockCount">0</span> ä¸ª)</div>
            <div class="subscription-list" id="subscriptionList">
                <div class="empty-state">æ­£åœ¨åŠ è½½...</div>
            </div>
        </div>
    </div>

    <script>
        // å­˜å‚¨ç®¡ç†å™¨ - ç®€åŒ–ç‰ˆ
        class SimpleStorageManager {
            constructor() {
                this.storageKey = 'marketbrew_permanent_subscriptions';
                this.subscriptions = this.loadSubscriptions();
                this.render();
                
                // ç›‘å¬é¡µé¢å…³é—­äº‹ä»¶
                window.addEventListener('beforeunload', () => this.saveSubscriptions());
                window.addEventListener('visibilitychange', () => {
                    if (document.hidden) this.saveSubscriptions();
                });
                
                console.log('ğŸ’¾ MarketBrew å­˜å‚¨ç®¡ç†å™¨å·²å¯åŠ¨');
            }

            loadSubscriptions() {
                try {
                    // å°è¯•ä»æ–°keyåŠ è½½
                    let saved = localStorage.getItem(this.storageKey);
                    
                    // å¦‚æœæ²¡æœ‰ï¼Œå°è¯•è¿ç§»æ—§æ•°æ®
                    if (!saved) {
                        const oldKeys = ['stockSubscriptions', 'marketbrew_subscriptions'];
                        for (const key of oldKeys) {
                            const oldData = localStorage.getItem(key);
                            if (oldData) {
                                saved = oldData;
                                this.saveSubscriptions(JSON.parse(oldData));
                                localStorage.removeItem(key);
                                console.log(`ğŸ”„ å·²è¿ç§»æ•°æ®ä» ${key}`);
                                break;
                            }
                        }
                    }
                    
                    if (saved) {
                        const data = JSON.parse(saved);
                        console.log(`âœ… åŠ è½½äº† ${data.length} ä¸ªè®¢é˜…`);
                        return data;
                    }
                } catch (e) {
                    console.error('âŒ åŠ è½½è®¢é˜…å¤±è´¥:', e);
                }
                
                // é»˜è®¤è®¢é˜…
                const defaultSubs = [
                    {symbol: '000001', name: 'å¹³å®‰é“¶è¡Œ', addedAt: new Date().toISOString()},
                    {symbol: '600519', name: 'è´µå·èŒ…å°', addedAt: new Date().toISOString()},
                    {symbol: '000858', name: 'äº”ç²®æ¶²', addedAt: new Date().toISOString()},
                    {symbol: '300750', name: 'å®å¾·æ—¶ä»£', addedAt: new Date().toISOString()}
                ];
                this.saveSubscriptions(defaultSubs);
                return defaultSubs;
            }

            saveSubscriptions(subs = this.subscriptions) {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(subs));
                    console.log(`ğŸ’¾ å·²ä¿å­˜ ${subs.length} ä¸ªè®¢é˜…`);
                    return true;
                } catch (e) {
                    console.error('âŒ ä¿å­˜è®¢é˜…å¤±è´¥:', e);
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å­˜å‚¨ç©ºé—´');
                    return false;
                }
            }

            addStock(symbol, name) {
                symbol = symbol.trim().toUpperCase();
                name = name.trim();
                
                if (!symbol || !name) {
                    alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç å’Œåç§°');
                    return false;
                }
                
                // æ£€æŸ¥é‡å¤
                if (this.subscriptions.find(sub => sub.symbol === symbol)) {
                    alert('è¯¥è‚¡ç¥¨å·²åœ¨è®¢é˜…åˆ—è¡¨ä¸­');
                    return false;
                }
                
                // æ·»åŠ è®¢é˜…
                this.subscriptions.push({
                    symbol: symbol,
                    name: name,
                    addedAt: new Date().toISOString()
                });
                
                if (this.saveSubscriptions()) {
                    this.render();
                    return true;
                }
                return false;
            }

            removeStock(symbol) {
                if (confirm(`ç¡®å®šè¦å–æ¶ˆè®¢é˜… ${symbol} å—ï¼Ÿ`)) {
                    this.subscriptions = this.subscriptions.filter(sub => sub.symbol !== symbol);
                    this.saveSubscriptions();
                    this.render();
                }
            }

            render() {
                const container = document.getElementById('subscriptionList');
                const counter = document.getElementById('stockCount');
                
                counter.textContent = this.subscriptions.length;
                
                if (this.subscriptions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            æš‚æ— è®¢é˜…è‚¡ç¥¨<br>
                            <small>æ·»åŠ æ‚¨å…³æ³¨çš„è‚¡ç¥¨å¼€å§‹ä½¿ç”¨</small>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = this.subscriptions.map(sub => `
                    <div class="subscription-item">
                        <div class="stock-info">
                            <h4>${sub.symbol}</h4>
                            <p>${sub.name}</p>
                            <small>æ·»åŠ äº: ${new Date(sub.addedAt).toLocaleDateString()}</small>
                        </div>
                        <button class="remove-btn" onclick="manager.removeStock('${sub.symbol}')">
                            åˆ é™¤
                        </button>
                    </div>
                `).join('');
            }

            getStorageInfo() {
                const data = localStorage.getItem(this.storageKey);
                const size = data ? (data.length / 1024).toFixed(2) : '0';
                const count = this.subscriptions.length;
                
                return {
                    count: count,
                    size: size + 'KB',
                    lastUpdate: new Date().toLocaleString(),
                    storageAvailable: this.testStorage()
                };
            }

            testStorage() {
                try {
                    const test = '__storage_test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            }

            exportData() {
                const data = {
                    subscriptions: this.subscriptions,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `marketbrew_backup_${new Date().getTime()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.subscriptions && Array.isArray(data.subscriptions)) {
                                if (confirm(`ç¡®å®šè¦å¯¼å…¥ ${data.subscriptions.length} ä¸ªè®¢é˜…å—ï¼Ÿè¿™ä¼šè¦†ç›–ç°æœ‰æ•°æ®ã€‚`)) {
                                    this.subscriptions = data.subscriptions;
                                    this.saveSubscriptions();
                                    this.render();
                                    alert('å¯¼å…¥æˆåŠŸï¼');
                                }
                            } else {
                                alert('æ–‡ä»¶æ ¼å¼é”™è¯¯');
                            }
                        } catch (e) {
                            alert('æ–‡ä»¶è§£æå¤±è´¥ï¼š' + e.message);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }
        }

        // åˆå§‹åŒ–ç®¡ç†å™¨
        const manager = new SimpleStorageManager();
        
        // å…¨å±€å‡½æ•°
        function addStock() {
            const input = document.getElementById('stockInput');
            const value = input.value.trim();
            
            if (!value) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä¿¡æ¯');
                return;
            }
            
            // ç®€å•è§£æ
            let symbol, name;
            if (value.includes(' ')) {
                [symbol, name] = value.split(' ');
            } else if (/^\d{6}$/.test(value)) {
                symbol = value;
                name = `è‚¡ç¥¨${value}`;
            } else {
                name = value;
                symbol = 'CODE' + Date.now().toString().slice(-6);
            }
            
            if (manager.addStock(symbol, name)) {
                input.value = '';
            }
        }

        function showStorageInfo() {
            const info = manager.getStorageInfo();
            const message = `
ğŸ“Š MarketBrew å­˜å‚¨è¯¦æƒ…

ğŸ“ˆ è®¢é˜…æ•°é‡: ${info.count} ä¸ª
ğŸ’¾ å­˜å‚¨å¤§å°: ${info.size}
ğŸ”„ æœ€åæ›´æ–°: ${info.lastUpdate}
âœ… å­˜å‚¨çŠ¶æ€: ${info.storageAvailable ? 'æ­£å¸¸' : 'å¼‚å¸¸'}

ğŸ›¡ï¸ æ•°æ®ä¿æŠ¤:
â€¢ ä½¿ç”¨ localStorage æ°¸ä¹…å­˜å‚¨
â€¢ å…³é—­æµè§ˆå™¨ä¸ä¼šä¸¢å¤±
â€¢ æ”¯æŒæ•°æ®å¯¼å‡ºå¤‡ä»½
â€¢ è‡ªåŠ¨è¿ç§»æ—§ç‰ˆæœ¬æ•°æ®

ğŸ’¡ æç¤º: å®šæœŸå¯¼å‡ºå¤‡ä»½ä»¥é˜²ä¸‡ä¸€
            `.trim();
            
            alert(message);
        }

        function clearAllData() {
            if (confirm('âš ï¸ ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®¢é˜…æ•°æ®å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼å»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ã€‚')) {
                localStorage.removeItem(manager.storageKey);
                alert('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…é™¤');
                location.reload();
            }
        }

        function exportData() {
            manager.exportData();
        }

        function importData() {
            manager.importData();
        }

        // ç›‘å¬å›è½¦é”®
        document.getElementById('stockInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addStock();
        });

        // é¡µé¢åŠ è½½å®Œæˆæç¤º
        window.addEventListener('load', () => {
            console.log('ğŸ‰ MarketBrew ç®€åŒ–ç‰ˆåŠ è½½å®Œæˆ');
            console.log('ğŸ’¾ æ•°æ®æ°¸ä¹…ä¿å­˜ï¼Œå…³é—­æµè§ˆå™¨ä¸ä¼šä¸¢å¤±');
        });
    </script>
</body>
</html>