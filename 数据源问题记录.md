# MarketBrew 数据源问题记录

## 📅 更新时间：2025-12-01

---

## ⚠️ 当前已知问题

### 1. 北向资金数据源不可用

**问题描述**：
- 东方财富免费API返回的北向资金数据不可用
- 多个测试的API端点均存在问题

**测试过的API端点**：

| API端点 | reportName/URL | 状态 | 问题描述 |
|---------|----------------|------|----------|
| datacenter API 1 | `RPT_MUTUAL_STOCK_NORTHSTA` | ❌ 失败 | 返回2024-08-16旧数据，金额为0 |
| datacenter API 2 | `RPT_MUTUAL_HOLD_DET` | ⚠️ 部分可用 | 返回持股详情，非流入流出数据 |
| datacenter API 3 | `RPT_MUTUAL_DEAL_HISTORY` | ❌ 失败 | 类型代码错误(001-006)，大部分金额为N/A |
| push2his API | `/api/qt/kamt.kline/get` | ❌ 失败 | 返回2025-10-20数据，金额全部为0 |
| push2 实时API | `/api/qt/kamt/get` | ❌ 失败 | 数据结构解析错误 |

**测试日期**：2025-12-01

**影响范围**：
- AI决策中心的"北向资金流向"面板无法显示真实数据
- 资金流向择时系统无法正常工作

**当前状态**：
- ✅ 市场涨跌统计功能正常（使用随机模拟数据）
- ❌ 北向资金流向功能不可用

---

## 🔍 问题分析

### 可能的原因

1. **API限制变更**
   - 东方财富可能对免费API增加了访问限制
   - 需要注册账号或付费才能访问完整数据

2. **数据更新延迟**
   - 免费API的数据更新可能有较大延迟
   - 最新数据可能只对付费用户开放

3. **接口调整**
   - API端点或参数可能已经变更
   - 需要使用新的接口或认证方式

4. **非交易时段限制**
   - 某些API可能仅在交易时段提供实时数据
   - 非交易时段返回旧数据或空数据

---

## 💡 可能的解决方案

### 方案1：寻找其他免费数据源（推荐）

**可探索的数据源**：
- Tushare（需要积分）
- AkShare（开源金融数据接口）
- 雪球网API
- 新浪财经API
- 腾讯财经API

**优点**：
- 完全免费
- 数据相对稳定

**缺点**：
- 需要重写数据获取逻辑
- 数据格式可能不同
- 部分需要注册认证

### 方案2：使用付费数据服务

**选项**：
- 东方财富Choice付费API
- Wind资讯
- 同花顺iFinD

**优点**：
- 数据质量高
- 更新及时
- 技术支持

**缺点**：
- 需要付费（通常较贵）
- 面向机构用户

### 方案3：Web爬虫（不推荐）

**说明**：
- 通过爬取网页获取数据
- 需要处理反爬机制

**缺点**：
- 可能违反网站服务条款
- 稳定性差
- 维护成本高

### 方案4：接受功能限制

**说明**：
- 暂时禁用北向资金功能
- 仅保留市场涨跌统计
- 在界面上说明"数据源暂不可用"

**优点**：
- 不需要额外成本
- 保持系统其他功能正常

**缺点**：
- 功能不完整
- 用户体验受影响

---

## 📝 临时解决方案

### 当前实施方案

**状态**：已实施

**方案**：
1. 保留北向资金面板UI
2. 显示"数据源暂不可用"提示
3. API返回空数据结构避免前端报错
4. 在项目文档中说明情况

**代码位置**：
- `capital_flow_timing_service.py:35-100`
- `decision_api_server.py:214-268`
- `ai_decision_center.html:3041-3086`

---

## 🎯 后续计划

### 短期（1-2周）

- [ ] 测试 AkShare 数据接口
- [ ] 测试 Tushare 数据接口
- [ ] 评估数据质量和稳定性

### 中期（1个月）

- [ ] 选择并集成新的数据源
- [ ] 重构数据获取逻辑
- [ ] 完善错误处理

### 长期

- [ ] 考虑建立数据缓存服务
- [ ] 支持多数据源切换
- [ ] 添加数据质量监控

---

## 📚 参考资料

### 测试脚本

项目中包含多个测试脚本用于诊断问题：

1. `test_eastmoney_direct.py` - 直接测试东方财富API
2. `test_multiple_apis.py` - 测试多个API端点
3. `test_api2_detail.py` - 详细查看API字段
4. `test_deal_history.py` - 测试交易历史API
5. `test_push2his_correct.py` - 测试历史K线API

### 相关文档

- `README_CAPITAL_TIMING.md` - 资金流向系统文档
- `ALPHABLOOM_TIMING_完成清单.md` - 择时系统完成清单
- `README_EASTMONEY_ONLY.md` - 东方财富数据源说明

---

## 📞 联系与反馈

如果您找到了可用的免费北向资金数据源，或有其他解决方案，欢迎补充到本文档。

---

**最后更新**：2025-12-01
**问题状态**：待解决
**优先级**：中等

